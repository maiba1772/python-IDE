<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Python IDE Professional - 企业级在线Python开发环境</title>
    
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <!-- StackFrame for error parsing -->
    <script src="https://cdn.jsdelivr.net/npm/stackframe@1.3.4/dist/stackframe.min.js"></script>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- FileSaver (使用非AMD版本) -->
    <script>define = undefined; require = undefined;</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>delete window.define; delete window.require;</script>
    
    <!-- Prism.js for syntax highlighting in terminal -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    
    <style>
        :root {
            --primary-color: #007acc;
            --secondary-color: #1e1e1e;
            --tertiary-color: #2d2d30;
            --quaternary-color: #3e3e42;
            --text-color: #d4d4d4;
            --success-color: #4ec9b0;
            --error-color: #f48771;
            --warning-color: #d7ba7d;
            --info-color: #569cd6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            overflow: hidden;
            user-select: none;
        }

        /* 加载界面 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--secondary-color) 0%, #252526 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
            background: rgba(45, 45, 48, 0.9);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .loading-logo {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .loading-title {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loading-subtitle {
            font-size: 14px;
            color: #969696;
            margin-bottom: 30px;
        }

        .loading-progress-container {
            width: 100%;
            height: 6px;
            background: var(--quaternary-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color));
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .loading-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .loading-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 12px;
            color: #969696;
        }

        .loading-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .loading-step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--quaternary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .loading-step.completed .loading-step-icon {
            background: var(--success-color);
        }

        .loading-step.active .loading-step-icon {
            background: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error-container {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: rgba(242, 135, 113, 0.1);
            border: 1px solid var(--error-color);
            border-radius: 5px;
        }

        .error-title {
            color: var(--error-color);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .error-details {
            color: #969696;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }

        .retry-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .retry-button:hover {
            background: #005a9e;
            transform: translateY(-2px);
        }

        /* 菜单栏 */
        .menu-bar {
            background-color: var(--tertiary-color);
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid var(--quaternary-color);
            position: relative;
            z-index: 100;
        }

        .menu-item {
            padding: 0 15px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
            position: relative;
            height: 100%;
        }

        .menu-item:hover {
            background-color: var(--quaternary-color);
        }

        .menu-dropdown {
            position: absolute;
            top: 35px;
            left: 0;
            background-color: var(--tertiary-color);
            border: 1px solid var(--quaternary-color);
            border-top: none;
            min-width: 200px;
            display: none;
            z-index: 101;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .menu-item:hover .menu-dropdown {
            display: block;
        }

        .dropdown-item {
            padding: 8px 15px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: var(--quaternary-color);
        }

        .dropdown-item .shortcut {
            margin-left: auto;
            color: #969696;
            font-size: 11px;
        }

        /* 工具栏 */
        .toolbar {
            background-color: var(--secondary-color);
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid var(--quaternary-color);
            gap: 5px;
        }

        .toolbar-group {
            display: flex;
            gap: 5px;
            padding: 0 10px;
            border-right: 1px solid var(--quaternary-color);
        }

        .toolbar-group:last-child {
            border-right: none;
            margin-left: auto;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            color: var(--text-color);
            position: relative;
        }

        .toolbar-btn:hover {
            background-color: var(--quaternary-color);
        }

        .toolbar-btn.active {
            background-color: var(--primary-color);
        }

        .toolbar-btn .tooltip {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #252526;
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .toolbar-btn:hover .tooltip {
            opacity: 1;
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background-color: var(--quaternary-color);
        }

        /* 搜索替换栏 */
        .search-replace-bar {
            background-color: var(--secondary-color);
            height: 40px;
            display: none;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid var(--quaternary-color);
            gap: 10px;
        }

        .search-replace-bar.active {
            display: flex;
        }

        .search-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: var(--tertiary-color);
            border-radius: 4px;
            padding: 0 10px;
        }

        .search-input {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 13px;
            width: 200px;
            outline: none;
            padding: 5px 0;
        }

        .search-input::placeholder {
            color: #969696;
        }

        .search-options {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .search-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #969696;
            cursor: pointer;
        }

        .search-option input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        /* 活动栏 */
        .activity-bar {
            background-color: #333337;
            width: 48px;
            height: calc(100vh - 75px);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 5px;
            float: left;
            position: relative;
            z-index: 99;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            position: relative;
            font-size: 16px;
        }

        .activity-icon:hover {
            background-color: var(--quaternary-color);
        }

        .activity-icon.active {
            background-color: var(--primary-color);
        }

        .activity-icon.active::before {
            content: '';
            position: absolute;
            left: 0;
            width: 3px;
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 2px;
        }

        .activity-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--error-color);
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 8px;
            min-width: 14px;
            text-align: center;
            font-weight: bold;
        }

        /* 侧边栏 */
        .sidebar {
            background-color: var(--secondary-color);
            width: 300px;
            height: calc(100vh - 75px);
            float: left;
            border-right: 1px solid var(--quaternary-color);
            display: none;
            overflow: hidden;
            transition: width 0.3s;
        }

        .sidebar.active {
            display: flex;
            flex-direction: column;
        }

        .sidebar.expanded {
            width: 400px;
        }

        .sidebar-header {
            background-color: var(--tertiary-color);
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            border-bottom: 1px solid var(--quaternary-color);
            font-size: 13px;
            font-weight: 500;
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
        }

        .sidebar-action {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            color: var(--text-color);
            opacity: 0.7;
        }

        .sidebar-action:hover {
            opacity: 1;
            background-color: var(--quaternary-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        /* 文件资源管理器 */
        .file-tree {
            padding: 5px;
        }

        .file-item {
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
        }

        .file-item:hover {
            background-color: var(--quaternary-color);
        }

        .file-item.active {
            background-color: #094771;
        }

        .file-item.modified::after {
            content: '•';
            position: absolute;
            right: 10px;
            color: var(--success-color);
            font-size: 16px;
        }

        .file-icon {
            width: 16px;
            text-align: center;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 11px;
            color: #969696;
            margin-left: auto;
            padding-right: 10px;
        }

        /* 主编辑区 */
        .main-container {
            height: calc(100vh - 75px);
            display: flex;
            flex-direction: column;
            margin-left: 48px;
            transition: margin-left 0.3s;
        }

        .main-container.sidebar-open {
            margin-left: 348px;
        }

        .main-container.sidebar-expanded {
            margin-left: 448px;
        }

        /* 标签栏 */
        .tabs-container {
            background-color: var(--secondary-color);
            height: 35px;
            display: flex;
            align-items: center;
            overflow-x: auto;
            border-bottom: 1px solid var(--quaternary-color);
            position: relative;
        }

        .tabs-container::-webkit-scrollbar {
            height: 3px;
        }

        .tabs-container::-webkit-scrollbar-track {
            background: var(--tertiary-color);
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: var(--quaternary-color);
            border-radius: 2px;
        }

        .tab {
            height: 100%;
            padding: 0 5px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            cursor: pointer;
            border-right: 1px solid var(--quaternary-color);
            background-color: var(--tertiary-color);
            min-width: 120px;
            max-width: 200px;
            position: relative;
            transition: background-color 0.2s;
        }

        .tab:hover {
            background-color: #2a2d2e;
        }

        .tab.active {
            background-color: var(--secondary-color);
        }

        .tab-icon {
            font-size: 14px;
            color: var(--success-color);
        }

        .tab-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 0;
        }

        .tab-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab.dirty .tab-title::after {
            content: ' •';
            color: var(--success-color);
        }

        .tab-close {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
            background-color: var(--quaternary-color);
        }

        .tab-add {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            margin-left: 2px;
        }

        .tab-add:hover {
            background-color: var(--quaternary-color);
        }

        /* 编辑器容器 */
        .editor-container {
            flex: 1;
            position: relative;
            background-color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-wrapper {
            flex: 1;
            position: relative;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        /* 调试面板 */
        .debug-panel {
            background-color: var(--secondary-color);
            height: 200px;
            border-top: 1px solid var(--quaternary-color);
            display: none;
            flex-direction: column;
        }

        .debug-panel.active {
            display: flex;
        }

        .debug-header {
            background-color: var(--tertiary-color);
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            border-bottom: 1px solid var(--quaternary-color);
            font-size: 12px;
        }

        .debug-tabs {
            display: flex;
            gap: 15px;
        }

        .debug-tab {
            cursor: pointer;
            padding: 5px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .debug-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .debug-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .debug-variable {
            padding: 5px 0;
            border-bottom: 1px solid var(--quaternary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debug-variable-name {
            color: #9cdcfe;
            font-weight: bold;
            min-width: 150px;
        }

        .debug-variable-type {
            color: #4ec9b0;
            font-size: 11px;
            padding: 2px 6px;
            background-color: var(--quaternary-color);
            border-radius: 3px;
        }

        .debug-variable-value {
            color: #ce9178;
            flex: 1;
        }

        /* 终端容器 */
        .terminal-container {
            height: 300px;
            background-color: var(--secondary-color);
            border-top: 1px solid var(--quaternary-color);
            display: flex;
            flex-direction: column;
            transition: height 0.3s;
        }

        .terminal-container.minimized {
            height: 30px;
        }

        .terminal-container.maximized {
            height: 60%;
        }

        .terminal-header {
            background-color: var(--tertiary-color);
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            cursor: pointer;
        }

        .terminal-title {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-actions {
            display: flex;
            gap: 10px;
        }

        .terminal-action {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            font-size: 12px;
        }

        .terminal-action:hover {
            opacity: 1;
        }

        .terminal-output {
            flex: 1;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            overflow-y: auto;
            background-color: #1e1e1e;
        }

        .terminal-line {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .terminal-line.input {
            color: #dcdcaa;
        }

        .terminal-line.output {
            color: var(--text-color);
        }

        .terminal-line.error {
            color: var(--error-color);
        }

        .terminal-line.success {
            color: var(--success-color);
        }

        .terminal-line.info {
            color: var(--info-color);
        }

        .terminal-input-container {
            display: flex;
            align-items: center;
            padding: 5px 15px;
            background-color: var(--tertiary-color);
            border-top: 1px solid var(--quaternary-color);
        }

        .terminal-prompt {
            color: var(--info-color);
            margin-right: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: bold;
        }

        .terminal-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-color);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            outline: none;
        }

        /* 状态栏 */
        .status-bar {
            background-color: var(--primary-color);
            height: 22px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            gap: 20px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .status-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .status-item i {
            font-size: 10px;
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--tertiary-color);
            border-radius: 8px;
            padding: 0;
            min-width: 400px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background-color: var(--secondary-color);
            padding: 15px 20px;
            border-bottom: 1px solid var(--quaternary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 500;
        }

        .modal-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            color: var(--text-color);
            opacity: 0.7;
        }

        .modal-close:hover {
            opacity: 1;
            background-color: var(--quaternary-color);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            background-color: var(--secondary-color);
            padding: 15px 20px;
            border-top: 1px solid var(--quaternary-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 表单元素 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--secondary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
        }

        .form-control::placeholder {
            color: #969696;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        select.form-control {
            cursor: pointer;
        }

        /* 按钮 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.3);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #005a9e;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--quaternary-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #4e4e52;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aa891;
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e34a32;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 14px;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* 代码片段 */
        .snippet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .snippet-item {
            background-color: var(--secondary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .snippet-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary-color);
            transform: translateX(-100%);
            transition: transform 0.2s;
        }

        .snippet-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .snippet-item:hover::before {
            transform: translateX(0);
        }

        .snippet-title {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--info-color);
        }

        .snippet-description {
            font-size: 12px;
            color: #969696;
            line-height: 1.4;
        }

        .snippet-code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            color: #ce9178;
            margin-top: 8px;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 设置面板 */
        .settings-section {
            margin-bottom: 25px;
        }

        .settings-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--info-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--quaternary-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 13px;
            color: var(--text-color);
        }

        .settings-description {
            font-size: 11px;
            color: #969696;
            margin-top: 2px;
        }

        .settings-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 开关 */
        .switch {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: var(--quaternary-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .switch.active {
            background-color: var(--primary-color);
        }

        .switch-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .switch.active .switch-handle {
            transform: translateX(20px);
        }

        /* 滑块 */
        .slider {
            width: 120px;
            height: 4px;
            background-color: var(--quaternary-color);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background-color: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            font-size: 12px;
            color: #969696;
        }

        /* 版本历史 */
        .version-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .version-item {
            padding: 15px;
            border-bottom: 1px solid var(--quaternary-color);
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .version-item:hover {
            background-color: rgba(0, 122, 204, 0.1);
        }

        .version-item:last-child {
            border-bottom: none;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .version-message {
            font-weight: 500;
            color: var(--text-color);
            flex: 1;
            margin-right: 10px;
        }

        .version-time {
            font-size: 11px;
            color: #969696;
            white-space: nowrap;
        }

        .version-details {
            font-size: 12px;
            color: #969696;
            line-height: 1.4;
        }

        .version-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .version-item:hover .version-actions {
            opacity: 1;
        }

        .version-action {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            color: var(--text-color);
        }

        .version-action:hover {
            background-color: var(--quaternary-color);
        }

        /* 右键菜单 */
        .context-menu {
            position: fixed;
            background-color: var(--tertiary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 6px;
            padding: 5px 0;
            min-width: 180px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: contextMenuSlideIn 0.2s ease-out;
        }

        @keyframes contextMenuSlideIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 8px 15px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
            color: var(--text-color);
        }

        .context-menu-item:hover {
            background-color: var(--quaternary-color);
        }

        .context-menu-item.danger {
            color: var(--error-color);
        }

        .context-menu-separator {
            height: 1px;
            background-color: var(--quaternary-color);
            margin: 5px 0;
        }

        /* 通知系统 */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .notification {
            background-color: var(--tertiary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: notificationSlideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--error-color);
        }

        .notification.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification.info {
            border-left: 4px solid var(--info-color);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-color);
        }

        .notification-close {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            color: #969696;
            opacity: 0.7;
        }

        .notification-close:hover {
            opacity: 1;
            background-color: var(--quaternary-color);
        }

        .notification-message {
            font-size: 13px;
            color: #969696;
            line-height: 1.4;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: var(--primary-color);
            transition: width linear;
        }

        /* 拖放区域 */
        .drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 122, 204, 0.1);
            border: 3px dashed var(--primary-color);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            backdrop-filter: blur(5px);
        }

        .drop-zone.active {
            display: flex;
        }

        .drop-zone-content {
            text-align: center;
            animation: dropZonePulse 2s infinite;
        }

        @keyframes dropZonePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .drop-zone-icon {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .drop-zone-text {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 300;
        }

        .drop-zone-subtext {
            font-size: 14px;
            color: #969696;
            margin-top: 10px;
        }

        /* 全屏模式 */
        .fullscreen .menu-bar,
        .fullscreen .toolbar,
        .fullscreen .activity-bar,
        .fullscreen .sidebar,
        .fullscreen .status-bar {
            display: none;
        }

        .fullscreen .main-container {
            margin-left: 0;
            height: 100vh;
        }

        .fullscreen .editor-container {
            height: 100%;
        }

        /* 快速打开 */
        .quick-open {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--tertiary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 8px;
            width: 600px;
            max-height: 400px;
            display: none;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .quick-open.active {
            display: flex;
        }

        .quick-open-input {
            padding: 15px;
            border-bottom: 1px solid var(--quaternary-color);
        }

        .quick-open-input input {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--secondary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 14px;
            outline: none;
        }

        .quick-open-list {
            flex: 1;
            overflow-y: auto;
        }

        .quick-open-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-open-item:hover {
            background-color: var(--quaternary-color);
        }

        .quick-open-item.active {
            background-color: var(--primary-color);
        }

        .quick-open-icon {
            width: 20px;
            text-align: center;
            color: var(--success-color);
        }

        .quick-open-name {
            flex: 1;
            font-size: 13px;
        }

        .quick-open-path {
            font-size: 11px;
            color: #969696;
        }

        /* 命令面板 */
        .command-palette {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--tertiary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 8px;
            width: 600px;
            max-height: 400px;
            display: none;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .command-palette.active {
            display: flex;
        }

        .command-palette-input {
            padding: 15px;
            border-bottom: 1px solid var(--quaternary-color);
        }

        .command-palette-input input {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--secondary-color);
            border: 1px solid var(--quaternary-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 14px;
            outline: none;
        }

        .command-palette-list {
            flex: 1;
            overflow-y: auto;
        }

        .command-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .command-item:hover {
            background-color: var(--quaternary-color);
        }

        .command-item.active {
            background-color: var(--primary-color);
        }

        .command-icon {
            width: 20px;
            text-align: center;
            color: var(--info-color);
        }

        .command-name {
            flex: 1;
            font-size: 13px;
        }

        .command-shortcut {
            font-size: 11px;
            color: #969696;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .main-container.sidebar-open {
                margin-left: 298px;
            }
            
            .modal-content {
                min-width: 90%;
                margin: 20px;
            }
            
            .quick-open,
            .command-palette {
                width: 90%;
                max-width: 400px;
            }
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--quaternary-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5e5e62;
        }

        /* Monaco Editor 自定义样式 */
        .monaco-editor .margin {
            background-color: var(--secondary-color);
        }

        .monaco-editor .line-numbers {
            color: #858585;
        }

        .monaco-editor .current-line {
            background-color: rgba(255, 255, 255, 0.07);
        }

        .monaco-editor .selection-highlight {
            background-color: rgba(0, 122, 204, 0.2);
        }

        .breakpoint-decoration {
            background-color: rgba(255, 0, 0, 0.1);
        }

        .breakpoint-glyph::before {
            content: '●';
            color: #ff0000;
            font-size: 14px;
        }

        /* 加载动画 */
        .skeleton {
            background: linear-gradient(90deg, var(--quaternary-color) 25%, var(--secondary-color) 50%, var(--quaternary-color) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* 工具提示 */
        .tooltip {
            position: absolute;
            background-color: #252526;
            color: var(--text-color);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #252526;
        }
    </style>
</head>
<body>
    <!-- 加载界面 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fab fa-python"></i>
            </div>
            <h1 class="loading-title">Web Python IDE Professional</h1>
            <p class="loading-subtitle">企业级在线Python开发环境</p>
            
            <div class="loading-progress-container">
                <div id="loadingProgressBar" class="loading-progress" style="width: 0%"></div>
            </div>
            <p id="loadingText" class="loading-text"></p>
            
            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <div class="loading-step-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <span>初始化</span>
                </div>
                <div class="loading-step" id="step2">
                    <div class="loading-step-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <span>加载资源</span>
                </div>
                <div class="loading-step" id="step3">
                    <div class="loading-step-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <span>配置环境</span>
                </div>
                <div class="loading-step" id="step4">
                    <div class="loading-step-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <span>启动完成</span>
                </div>
            </div>
            
            <div id="errorContainer" class="error-container">
                <div class="error-title">
                    <i class="fas fa-exclamation-triangle"></i> 初始化失败
                </div>
                <div id="errorDetails" class="error-details"></div>
                <button class="retry-button" onclick="retryInitialization()">
                    <i class="fas fa-redo"></i> 重试
                </button>
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="mainApp" style="display: none;">
        <!-- 菜单栏 -->
        <div class="menu-bar">
            <div class="menu-item">
                <i class="fas fa-file"></i>
                文件
                <div class="menu-dropdown">
                    <div class="dropdown-item" onclick="showNewFileDialog()">
                        <i class="fas fa-file-plus"></i> 新建文件
                        <span class="shortcut">Ctrl+N</span>
                    </div>
                    <div class="dropdown-item" onclick="showNewFolderDialog()">
                        <i class="fas fa-folder-plus"></i> 新建文件夹
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="showImportDialog()">
                        <i class="fas fa-file-import"></i> 导入文件
                        <span class="shortcut">Ctrl+O</span>
                    </div>
                    <div class="dropdown-item" onclick="showImportProjectDialog()">
                        <i class="fas fa-folder-open"></i> 导入项目
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="exportCurrentFile()">
                        <i class="fas fa-file-export"></i> 导出文件
                        <span class="shortcut">Ctrl+S</span>
                    </div>
                    <div class="dropdown-item" onclick="exportProject()">
                        <i class="fas fa-download"></i> 导出项目
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="shareProject()">
                        <i class="fas fa-share-alt"></i> 分享项目
                    </div>
                </div>
            </div>
            
            <div class="menu-item">
                <i class="fas fa-edit"></i>
                编辑
                <div class="menu-dropdown">
                    <div class="dropdown-item" onclick="editor.getAction('undo').run()">
                        <i class="fas fa-undo"></i> 撤销
                        <span class="shortcut">Ctrl+Z</span>
                    </div>
                    <div class="dropdown-item" onclick="editor.getAction('redo').run()">
                        <i class="fas fa-redo"></i> 重做
                        <span class="shortcut">Ctrl+Y</span>
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="editor.getAction('editor.action.formatDocument').run()">
                        <i class="fas fa-align-left"></i> 格式化代码
                        <span class="shortcut">Shift+Alt+F</span>
                    </div>
                    <div class="dropdown-item" onclick="toggleSearchReplace()">
                        <i class="fas fa-search"></i> 查找替换
                        <span class="shortcut">Ctrl+F</span>
                    </div>
                    <div class="dropdown-item" onclick="showSnippetsDialog()">
                        <i class="fas fa-code"></i> 代码片段
                        <span class="shortcut">Ctrl+Shift+P</span>
                    </div>
                </div>
            </div>
            
            <div class="menu-item">
                <i class="fas fa-play"></i>
                运行
                <div class="menu-dropdown">
                    <div class="dropdown-item" onclick="runCode()">
                        <i class="fas fa-play"></i> 运行代码
                        <span class="shortcut">F5</span>
                    </div>
                    <div class="dropdown-item" onclick="debugCode()">
                        <i class="fas fa-bug"></i> 调试代码
                        <span class="shortcut">F6</span>
                    </div>
                    <div class="dropdown-item" onclick="stopExecution()">
                        <i class="fas fa-stop"></i> 停止执行
                        <span class="shortcut">Shift+F5</span>
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="runSelection()">
                        <i class="fas fa-play-circle"></i> 运行选中代码
                        <span class="shortcut">Ctrl+Enter</span>
                    </div>
                </div>
            </div>
            
            <div class="menu-item">
                <i class="fas fa-code-branch"></i>
                版本控制
                <div class="menu-dropdown">
                    <div class="dropdown-item" onclick="saveVersion()">
                        <i class="fas fa-save"></i> 保存版本
                        <span class="shortcut">Ctrl+Shift+S</span>
                    </div>
                    <div class="dropdown-item" onclick="showVersionHistory()">
                        <i class="fas fa-history"></i> 查看历史
                    </div>
                    <div class="dropdown-item" onclick="compareVersions()">
                        <i class="fas fa-code-compare"></i> 比较版本
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="showGitSettings()">
                        <i class="fas fa-cog"></i> 版本控制设置
                    </div>
                </div>
            </div>
            
            <div class="menu-item">
                <i class="fas fa-cog"></i>
                设置
                <div class="menu-dropdown">
                    <div class="dropdown-item" onclick="showSettingsDialog()">
                        <i class="fas fa-sliders-h"></i> 编辑器设置
                    </div>
                    <div class="dropdown-item" onclick="showThemeDialog()">
                        <i class="fas fa-palette"></i> 主题设置
                    </div>
                    <div class="dropdown-item" onclick="showShortcutsDialog()">
                        <i class="fas fa-keyboard"></i> 快捷键设置
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" onclick="showExtensionsDialog()">
                        <i class="fas fa-puzzle-piece"></i> 扩展管理
                    </div>
                </div>
            </div>
            
            <div class="menu-item" style="margin-left: auto;">
                <i class="fas fa-question-circle"></i>
                帮助
                <div class="menu-dropdown">
                    <div class="dropdown-item" onclick="showDocumentation()">
                        <i class="fas fa-book"></i> 文档
                    </div>
                    <div class="dropdown-item" onclick="showShortcutsDialog()">
                        <i class="fas fa-keyboard"></i> 快捷键参考
                    </div>
                    <div class="dropdown-item" onclick="showAboutDialog()">
                        <i class="fas fa-info-circle"></i> 关于
                    </div>
                </div>
            </div>
        </div>

        <!-- 工具栏 -->
        <div class="toolbar">
            <div class="toolbar-group">
                <div class="toolbar-btn" onclick="showNewFileDialog()" title="新建文件">
                    <i class="fas fa-file-plus"></i>
                    <span class="tooltip">新建文件</span>
                </div>
                <div class="toolbar-btn" onclick="showImportDialog()" title="打开文件">
                    <i class="fas fa-folder-open"></i>
                    <span class="tooltip">打开文件</span>
                </div>
                <div class="toolbar-btn" onclick="saveVersion()" title="保存">
                    <i class="fas fa-save"></i>
                    <span class="tooltip">保存</span>
                </div>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <div class="toolbar-group">
                <div class="toolbar-btn" onclick="editor.getAction('undo').run()" title="撤销">
                    <i class="fas fa-undo"></i>
                    <span class="tooltip">撤销</span>
                </div>
                <div class="toolbar-btn" onclick="editor.getAction('redo').run()" title="重做">
                    <i class="fas fa-redo"></i>
                    <span class="tooltip">重做</span>
                </div>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <div class="toolbar-group">
                <div class="toolbar-btn" onclick="runCode()" title="运行">
                    <i class="fas fa-play"></i>
                    <span class="tooltip">运行</span>
                </div>
                <div class="toolbar-btn" onclick="debugCode()" title="调试">
                    <i class="fas fa-bug"></i>
                    <span class="tooltip">调试</span>
                </div>
                <div class="toolbar-btn" onclick="stopExecution()" title="停止">
                    <i class="fas fa-stop"></i>
                    <span class="tooltip">停止</span>
                </div>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <div class="toolbar-group">
                <div class="toolbar-btn" onclick="toggleSearchReplace()" title="查找">
                    <i class="fas fa-search"></i>
                    <span class="tooltip">查找</span>
                </div>
                <div class="toolbar-btn" onclick="editor.getAction('editor.action.formatDocument').run()" title="格式化">
                    <i class="fas fa-align-left"></i>
                    <span class="tooltip">格式化</span>
                </div>
            </div>
            
            <div class="toolbar-separator"></div>
            
            <div class="toolbar-group">
                <div class="toolbar-btn" onclick="showSnippetsDialog()" title="代码片段">
                    <i class="fas fa-code"></i>
                    <span class="tooltip">代码片段</span>
                </div>
                <div class="toolbar-btn" onclick="toggleTerminal()" title="终端">
                    <i class="fas fa-terminal"></i>
                    <span class="tooltip">终端</span>
                </div>
                <div class="toolbar-btn" onclick="toggleDebugPanel()" title="调试面板">
                    <i class="fas fa-bug"></i>
                    <span class="tooltip">调试面板</span>
                </div>
            </div>
            
            <div class="toolbar-group">
                <div class="toolbar-btn" onclick="showCommandPalette()" title="命令面板">
                    <i class="fas fa-terminal"></i>
                    <span class="tooltip">命令面板</span>
                </div>
                <div class="toolbar-btn" onclick="toggleFullscreen()" title="全屏">
                    <i class="fas fa-expand"></i>
                    <span class="tooltip">全屏</span>
                </div>
            </div>
        </div>

        <!-- 搜索替换栏 -->
        <div id="searchReplaceBar" class="search-replace-bar">
            <div class="search-input-group">
                <i class="fas fa-search" style="color: #969696;"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="查找">
            </div>
            <div class="search-input-group">
                <i class="fas fa-exchange-alt" style="color: #969696;"></i>
                <input type="text" class="search-input" id="replaceInput" placeholder="替换">
            </div>
            <div class="toolbar-btn" onclick="findNext()" title="查找下一个">
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="toolbar-btn" onclick="findPrevious()" title="查找上一个">
                <i class="fas fa-chevron-up"></i>
            </div>
            <div class="toolbar-btn" onclick="replace()" title="替换">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <div class="toolbar-btn" onclick="replaceAll()" title="替换全部">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <div class="toolbar-btn" onclick="toggleSearchReplace()" title="关闭">
                <i class="fas fa-times"></i>
            </div>
            <div class="search-options">
                <label class="search-option">
                    <input type="checkbox" id="searchCaseSensitive">
                    <span>区分大小写</span>
                </label>
                <label class="search-option">
                    <input type="checkbox" id="searchWholeWord">
                    <span>全词匹配</span>
                </label>
                <label class="search-option">
                    <input type="checkbox" id="searchRegex">
                    <span>使用正则</span>
                </label>
            </div>
        </div>

        <!-- 活动栏 -->
        <div class="activity-bar">
            <div class="activity-icon active" onclick="toggleSidebar('explorer')" title="文件资源管理器">
                <i class="fas fa-folder"></i>
            </div>
            <div class="activity-icon" onclick="toggleSidebar('search')" title="搜索">
                <i class="fas fa-search"></i>
            </div>
            <div class="activity-icon" onclick="toggleSidebar('git')" title="版本控制">
                <i class="fas fa-code-branch"></i>
                <span id="versionBadge" class="activity-badge" style="display: none;">0</span>
            </div>
            <div class="activity-icon" onclick="toggleSidebar('debug')" title="调试">
                <i class="fas fa-bug"></i>
            </div>
            <div class="activity-icon" onclick="toggleSidebar('extensions')" title="扩展">
                <i class="fas fa-puzzle-piece"></i>
            </div>
            <div class="activity-icon" onclick="showSettingsDialog()" title="设置">
                <i class="fas fa-cog"></i>
            </div>
        </div>

        <!-- 侧边栏 -->
        <div id="sidebar" class="sidebar active">
            <!-- 文件资源管理器面板 -->
            <div id="explorer-panel" class="sidebar-panel" style="display: flex; flex-direction: column; flex: 1;">
                <div class="sidebar-header">
                    <span>文件资源管理器</span>
                    <div class="sidebar-actions">
                        <div class="sidebar-action" onclick="showNewFileDialog()" title="新建文件">
                            <i class="fas fa-file-plus"></i>
                        </div>
                        <div class="sidebar-action" onclick="showNewFolderDialog()" title="新建文件夹">
                            <i class="fas fa-folder-plus"></i>
                        </div>
                        <div class="sidebar-action" onclick="refreshFileTree()" title="刷新">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="sidebar-action" onclick="toggleSidebarWidth()" title="展开/收缩">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </div>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div class="file-tree" id="fileTree">
                        <!-- 文件树将在这里动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 搜索面板 -->
            <div id="search-panel" class="sidebar-panel" style="display: none; flex-direction: column; flex: 1;">
                <div class="sidebar-header">
                    <span>搜索</span>
                    <div class="sidebar-actions">
                        <div class="sidebar-action" onclick="clearSearchResults()" title="清除结果">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="sidebar-action" onclick="toggleSidebarWidth()" title="展开/收缩">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </div>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div style="padding: 15px;">
                        <input type="text" class="form-control" placeholder="在文件中搜索..." onkeyup="performSearch(this.value)">
                    </div>
                    <div id="searchResults">
                        <!-- 搜索结果将在这里显示 -->
                    </div>
                </div>
            </div>
            
            <!-- 版本控制面板 -->
            <div id="git-panel" class="sidebar-panel" style="display: none; flex-direction: column; flex: 1;">
                <div class="sidebar-header">
                    <span>版本历史</span>
                    <div class="sidebar-actions">
                        <div class="sidebar-action" onclick="saveVersion()" title="保存版本">
                            <i class="fas fa-save"></i>
                        </div>
                        <div class="sidebar-action" onclick="refreshVersionHistory()" title="刷新">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="sidebar-action" onclick="toggleSidebarWidth()" title="展开/收缩">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </div>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div class="version-list" id="versionHistory">
                        <!-- 版本历史将在这里动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 调试面板 -->
            <div id="debug-panel" class="sidebar-panel" style="display: none; flex-direction: column; flex: 1;">
                <div class="sidebar-header">
                    <span>调试</span>
                    <div class="sidebar-actions">
                        <div class="sidebar-action" onclick="debugCode()" title="开始调试">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="sidebar-action" onclick="stopExecution()" title="停止调试">
                            <i class="fas fa-stop"></i>
                        </div>
                        <div class="sidebar-action" onclick="clearDebugVariables()" title="清除变量">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="sidebar-action" onclick="toggleSidebarWidth()" title="展开/收缩">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </div>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div id="debugVariables">
                        <!-- 调试变量将在这里动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 扩展面板 -->
            <div id="extensions-panel" class="sidebar-panel" style="display: none; flex-direction: column; flex: 1;">
                <div class="sidebar-header">
                    <span>扩展</span>
                    <div class="sidebar-actions">
                        <div class="sidebar-action" onclick="installExtension()" title="安装扩展">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="sidebar-action" onclick="refreshExtensions()" title="刷新">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="sidebar-action" onclick="toggleSidebarWidth()" title="展开/收缩">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </div>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div id="extensionsList">
                        <!-- 扩展列表将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 主容器 -->
        <div id="mainContainer" class="main-container sidebar-open">
            <!-- 标签栏 -->
            <div class="tabs-container" id="tabsContainer">
                <!-- 标签将在这里动态生成 -->
                <div class="tab-add" onclick="showNewFileDialog()">
                    <i class="fas fa-plus"></i>
                </div>
            </div>

            <!-- 编辑器容器 -->
            <div class="editor-container">
                <div class="editor-wrapper">
                    <div id="editor"></div>
                </div>
                
                <!-- 调试面板 -->
                <div id="debugPanel" class="debug-panel">
                    <div class="debug-header">
                        <div class="debug-tabs">
                            <div class="debug-tab active" onclick="switchDebugTab('variables')">变量</div>
                            <div class="debug-tab" onclick="switchDebugTab('watch')">监视</div>
                            <div class="debug-tab" onclick="switchDebugTab('callstack')">调用堆栈</div>
                            <div class="debug-tab" onclick="switchDebugTab('breakpoints')">断点</div>
                        </div>
                        <div class="terminal-actions">
                            <i class="fas fa-times terminal-action" onclick="toggleDebugPanel()"></i>
                        </div>
                    </div>
                    <div class="debug-content" id="debugContent">
                        <!-- 调试信息将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 终端容器 -->
            <div class="terminal-container" id="terminalContainer">
                <div class="terminal-header" onclick="toggleTerminal()">
                    <div class="terminal-title">
                        <i class="fas fa-terminal"></i>
                        <span>终端</span>
                    </div>
                    <div class="terminal-actions">
                        <i class="fas fa-plus terminal-action" onclick="event.stopPropagation(); newTerminal()" title="新建终端"></i>
                        <i class="fas fa-minus terminal-action" onclick="event.stopPropagation(); minimizeTerminal()" title="最小化"></i>
                        <i class="fas fa-expand terminal-action" onclick="event.stopPropagation(); maximizeTerminal()" title="最大化"></i>
                        <i class="fas fa-times terminal-action" onclick="event.stopPropagation(); closeTerminal()" title="关闭"></i>
                    </div>
                </div>
                <div class="terminal-output" id="terminalOutput">
                    <div class="terminal-line success">Web Python IDE Professional - Python 3.11.3</div>
                    <div class="terminal-line info">Type 'help()' for more information.</div>
                </div>
                <div class="terminal-input-container">
                    <span class="terminal-prompt">>>></span>
                    <input type="text" class="terminal-input" id="terminalInput" placeholder="" onkeypress="handleTerminalInput(event)">
                </div>
            </div>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-item" onclick="showQuickInfo()">
                <i class="fas fa-circle" style="color: var(--success-color);"></i>
                <span id="statusText">就绪</span>
            </div>
            <div class="status-item">
                <i class="fas fa-file-code"></i>
                <span id="languageText">Python</span>
            </div>
            <div class="status-item">
                <i class="fas fa-code-branch"></i>
                <span id="versionCount">0 版本</span>
            </div>
            <div class="status-item">
                <i class="fas fa-bug"></i>
                <span id="debugStatus">未调试</span>
            </div>
            <div class="status-item" style="margin-left: auto;">
                <i class="fas fa-keyboard"></i>
                <span id="encodingText">UTF-8</span>
            </div>
            <div class="status-item">
                <i class="fas fa-text-height"></i>
                <span id="fontSizeText">14px</span>
            </div>
            <div class="status-item">
                <i class="fas fa-plug"></i>
                <span id="connectionStatus">已连接</span>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="renameFile()">
            <i class="fas fa-edit"></i> 重命名
        </div>
        <div class="context-menu-item" onclick="duplicateFile()">
            <i class="fas fa-copy"></i> 复制
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteFile()">
            <i class="fas fa-trash"></i> 删除
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="exportCurrentFile()">
            <i class="fas fa-download"></i> 导出
        </div>
        <div class="context-menu-item" onclick="shareFile()">
            <i class="fas fa-share-alt"></i> 分享
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item danger" onclick="deleteFile()">
            <i class="fas fa-trash-alt"></i> 永久删除
        </div>
    </div>

    <!-- 新建文件对话框 -->
    <div id="newFileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">新建文件</div>
                <div class="modal-close" onclick="closeModal('newFileModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">文件名</label>
                    <input type="text" class="form-control" id="newFileName" placeholder="输入文件名 (例如: main.py)">
                </div>
                <div class="form-group">
                    <label class="form-label">模板</label>
                    <select class="form-control" id="fileTemplate">
                        <option value="blank">空白文件</option>
                        <option value="hello">Hello World</option>
                        <option value="function">函数模板</option>
                        <option value="class">类模板</option>
                        <option value="script">脚本模板</option>
                        <option value="web">Web应用模板</option>
                        <option value="test">测试模板</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">位置</label>
                    <select class="form-control" id="fileLocation">
                        <option value="/">根目录</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newFileModal')">取消</button>
                <button class="btn btn-primary" onclick="createNewFile()">创建</button>
            </div>
        </div>
    </div>

    <!-- 新建文件夹对话框 -->
    <div id="newFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">新建文件夹</div>
                <div class="modal-close" onclick="closeModal('newFolderModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">文件夹名称</label>
                    <input type="text" class="form-control" id="newFolderName" placeholder="输入文件夹名称">
                </div>
                <div class="form-group">
                    <label class="form-label">位置</label>
                    <select class="form-control" id="folderLocation">
                        <option value="/">根目录</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newFolderModal')">取消</button>
                <button class="btn btn-primary" onclick="createNewFolder()">创建</button>
            </div>
        </div>
    </div>

    <!-- 导入文件对话框 -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">导入文件</div>
                <div class="modal-close" onclick="closeModal('importModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">选择文件</label>
                    <input type="file" class="form-control" id="importFile" accept=".py,.txt,.json,.csv,.md,.html,.css,.js" multiple>
                    <small style="color: #969696; font-size: 12px;">支持格式: .py, .txt, .json, .csv, .md, .html, .css, .js</small>
                </div>
                <div class="form-group">
                    <label class="form-label">导入到</label>
                    <select class="form-control" id="importLocation">
                        <option value="/">根目录</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">取消</button>
                <button class="btn btn-primary" onclick="importFiles()">导入</button>
            </div>
        </div>
    </div>

    <!-- 导入项目对话框 -->
    <div id="importProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">导入项目</div>
                <div class="modal-close" onclick="closeModal('importProjectModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">选择项目文件夹</label>
                    <input type="file" class="form-control" id="importProjectFile" webkitdirectory directory multiple>
                    <small style="color: #969696; font-size: 12px;">选择包含Python项目的文件夹，将自动导入所有.py文件</small>
                </div>
                <div class="form-group">
                    <label class="form-label">项目名称</label>
                    <input type="text" class="form-control" id="projectName" placeholder="输入项目名称">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importProjectModal')">取消</button>
                <button class="btn btn-primary" onclick="importProject()">导入</button>
            </div>
        </div>
    </div>

    <!-- 保存版本对话框 -->
    <div id="saveVersionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">保存版本</div>
                <div class="modal-close" onclick="closeModal('saveVersionModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">版本标题</label>
                    <input type="text" class="form-control" id="versionMessage" placeholder="输入版本标题">
                </div>
                <div class="form-group">
                    <label class="form-label">版本描述</label>
                    <textarea class="form-control" id="versionDescription" placeholder="输入版本详细描述（可选）" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">标签</label>
                    <input type="text" class="form-control" id="versionTags" placeholder="输入标签，用逗号分隔">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('saveVersionModal')">取消</button>
                <button class="btn btn-primary" onclick="saveCurrentVersion()">保存</button>
            </div>
        </div>
    </div>

    <!-- 设置对话框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">设置</div>
                <div class="modal-close" onclick="closeModal('settingsModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fas fa-edit"></i> 编辑器设置
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">字体大小</div>
                            <div class="settings-description">编辑器中文字的大小</div>
                        </div>
                        <div class="settings-control">
                            <input type="range" class="slider" id="fontSizeSlider" min="10" max="24" value="14" onchange="updateFontSize(this.value)">
                            <span class="slider-value" id="fontSizeValue">14px</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">字体族</div>
                            <div class="settings-description">编辑器使用的字体</div>
                        </div>
                        <div class="settings-control">
                            <select class="form-control" id="fontFamily" onchange="updateFontFamily(this.value)" style="width: 200px;">
                                <option value="'Consolas', 'Monaco', monospace">Consolas</option>
                                <option value="'Courier New', monospace">Courier New</option>
                                <option value="'Source Code Pro', monospace">Source Code Pro</option>
                                <option value="'Fira Code', monospace">Fira Code</option>
                                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">自动缩进</div>
                            <div class="settings-description">自动为新行添加适当的缩进</div>
                        </div>
                        <div class="settings-control">
                            <div class="switch active" id="autoIndentSwitch" onclick="toggleSwitch(this)">
                                <div class="switch-handle"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">自动保存</div>
                            <div class="settings-description">自动保存文件的更改</div>
                        </div>
                        <div class="settings-control">
                            <div class="switch" id="autoSaveSwitch" onclick="toggleSwitch(this)">
                                <div class="switch-handle"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">行号显示</div>
                            <div class="settings-description">在编辑器左侧显示行号</div>
                        </div>
                        <div class="settings-control">
                            <div class="switch active" id="lineNumbersSwitch" onclick="toggleSwitch(this)">
                                <div class="switch-handle"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">小地图</div>
                            <div class="settings-description">在编辑器右侧显示代码缩略图</div>
                        </div>
                        <div class="settings-control">
                            <div class="switch active" id="minimapSwitch" onclick="toggleSwitch(this)">
                                <div class="switch-handle"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">单词换行</div>
                            <div class="settings-description">自动换行长行</div>
                        </div>
                        <div class="settings-control">
                            <div class="switch active" id="wordWrapSwitch" onclick="toggleSwitch(this)">
                                <div class="switch-handle"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fas fa-terminal"></i> 终端设置
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">自动滚动</div>
                            <div class="settings-description">新输出时自动滚动到底部</div>
                        </div>
                        <div class="settings-control">
                            <div class="switch active" id="terminalAutoScrollSwitch" onclick="toggleSwitch(this)">
                                <div class="switch-handle"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">终端字体大小</div>
                            <div class="settings-description">终端中文字的大小</div>
                        </div>
                        <div class="settings-control">
                            <input type="range" class="slider" id="terminalFontSizeSlider" min="10" max="20" value="14" onchange="updateTerminalFontSize(this.value)">
                            <span class="slider-value" id="terminalFontSizeValue">14px</span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">最大行数</div>
                            <div class="settings-description">终端保留的最大行数</div>
                        </div>
                        <div class="settings-control">
                            <select class="form-control" id="terminalMaxLines" onchange="updateTerminalMaxLines(this.value)" style="width: 120px;">
                                <option value="1000">1000</option>
                                <option value="2000">2000</option>
                                <option value="5000" selected>5000</option>
                                <option value="10000">10000</option>
                                <option value="20000">20000</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fas fa-palette"></i> 主题设置
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">主题</div>
                            <div class="settings-description">选择编辑器的主题</div>
                        </div>
                        <div class="settings-control">
                            <select class="form-control" id="themeSelect" onchange="updateTheme(this.value)" style="width: 150px;">
                                <option value="vs-dark">深色</option>
                                <option value="vs">浅色</option>
                                <option value="hc-black">高对比度</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetSettings()">重置设置</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 代码片段对话框 -->
    <div id="snippetsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">代码片段</div>
                <div class="modal-close" onclick="closeModal('snippetsModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="snippet-grid">
                    <div class="snippet-item" onclick="insertSnippet('for-loop')">
                        <div class="snippet-title">For 循环</div>
                        <div class="snippet-description">插入 for 循环模板</div>
                        <div class="snippet-code">for item in iterable:</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('while-loop')">
                        <div class="snippet-title">While 循环</div>
                        <div class="snippet-description">插入 while 循环模板</div>
                        <div class="snippet-code">while condition:</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('if-else')">
                        <div class="snippet-title">If-Else</div>
                        <div class="snippet-description">插入条件语句模板</div>
                        <div class="snippet-code">if condition:</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('function')">
                        <div class="snippet-title">函数定义</div>
                        <div class="snippet-description">插入函数定义模板</div>
                        <div class="snippet-code">def function_name():</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('class')">
                        <div class="snippet-title">类定义</div>
                        <div class="snippet-description">插入类定义模板</div>
                        <div class="snippet-code">class ClassName:</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('try-except')">
                        <div class="snippet-title">异常处理</div>
                        <div class="snippet-description">插入 try-except 模板</div>
                        <div class="snippet-code">try:</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('list-comprehension')">
                        <div class="snippet-title">列表推导</div>
                        <div class="snippet-description">插入列表推导模板</div>
                        <div class="snippet-code">[x for x in iterable]</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('decorator')">
                        <div class="snippet-title">装饰器</div>
                        <div class="snippet-description">插入装饰器模板</div>
                        <div class="snippet-code">@decorator</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('main')">
                        <div class="snippet-title">主函数</div>
                        <div class="snippet-description">插入主函数模板</div>
                        <div class="snippet-code">if __name__ == "__main__":</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('import')">
                        <div class="snippet-title">导入模块</div>
                        <div class="snippet-description">插入导入语句模板</div>
                        <div class="snippet-code">import module</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('lambda')">
                        <div class="snippet-title">Lambda函数</div>
                        <div class="snippet-description">插入lambda表达式模板</div>
                        <div class="snippet-code">lambda x: x</div>
                    </div>
                    <div class="snippet-item" onclick="insertSnippet('with')">
                        <div class="snippet-title">上下文管理器</div>
                        <div class="snippet-description">插入with语句模板</div>
                        <div class="snippet-code">with open() as f:</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷键对话框 -->
    <div id="shortcutsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">快捷键参考</div>
                <div class="modal-close" onclick="closeModal('shortcutsModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--quaternary-color);">
                            <th style="padding: 10px; text-align: left; color: var(--info-color);">功能</th>
                            <th style="padding: 10px; text-align: left; color: var(--info-color);">快捷键</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">新建文件</td>
                            <td style="padding: 10px;"><kbd>Ctrl+N</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">打开文件</td>
                            <td style="padding: 10px;"><kbd>Ctrl+O</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">保存文件</td>
                            <td style="padding: 10px;"><kbd>Ctrl+S</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">保存版本</td>
                            <td style="padding: 10px;"><kbd>Ctrl+Shift+S</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">运行代码</td>
                            <td style="padding: 10px;"><kbd>F5</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">调试代码</td>
                            <td style="padding: 10px;"><kbd>F6</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">停止执行</td>
                            <td style="padding: 10px;"><kbd>Shift+F5</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">查找替换</td>
                            <td style="padding: 10px;"><kbd>Ctrl+F</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">格式化代码</td>
                            <td style="padding: 10px;"><kbd>Shift+Alt+F</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">切换终端</td>
                            <td style="padding: 10px;"><kbd>Ctrl+`</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">命令面板</td>
                            <td style="padding: 10px;"><kbd>Ctrl+Shift+P</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">全屏模式</td>
                            <td style="padding: 10px;"><kbd>F11</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">撤销</td>
                            <td style="padding: 10px;"><kbd>Ctrl+Z</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">重做</td>
                            <td style="padding: 10px;"><kbd>Ctrl+Y</kbd></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--quaternary-color);">
                            <td style="padding: 10px;">运行选中代码</td>
                            <td style="padding: 10px;"><kbd>Ctrl+Enter</kbd></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 关于对话框 -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">关于 Web Python IDE Professional</div>
                <div class="modal-close" onclick="closeModal('aboutModal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;">
                    <i class="fab fa-python"></i>
                </div>
                <h2 style="margin-bottom: 10px;">Web Python IDE Professional</h2>
                <p style="color: #969696; margin-bottom: 20px;">版本 1.0.0</p>
                <p style="line-height: 1.6; margin-bottom: 20px;">
                    一个功能强大的在线Python开发环境，提供专业的编码体验。
                    支持代码编辑、调试、版本控制等完整功能。
                </p>
                <div style="border-top: 1px solid var(--quaternary-color); padding-top: 20px; margin-top: 20px;">
                    <p style="font-size: 12px; color: #969696;">
                        基于 Monaco Editor 和 Pyodide 构建<br>
                        © 2024 Web Python IDE Professional. All rights reserved.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('aboutModal')">确定</button>
            </div>
        </div>
    </div>

    <!-- 快速打开 -->
    <div id="quickOpen" class="quick-open">
        <div class="quick-open-input">
            <input type="text" placeholder="输入文件名以快速打开..." onkeyup="filterQuickOpen(this.value)">
        </div>
        <div class="quick-open-list" id="quickOpenList">
            <!-- 快速打开列表将在这里动态生成 -->
        </div>
    </div>

    <!-- 命令面板 -->
    <div id="commandPalette" class="command-palette">
        <div class="command-palette-input">
            <input type="text" placeholder="输入命令名称..." onkeyup="filterCommands(this.value)">
        </div>
        <div class="command-palette-list" id="commandList">
            <!-- 命令列表将在这里动态生成 -->
        </div>
    </div>

    <!-- 拖放区域 -->
    <div id="dropZone" class="drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="drop-zone-text">拖放文件到这里导入</div>
            <div class="drop-zone-subtext">支持单个文件或整个文件夹</div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="notificationContainer" class="notification-container">
        <!-- 通知将在这里动态生成 -->
    </div>

    <script>
        // 全局变量
        let editor;
        let pyodide;
        let files = {};
        let folders = {};
        let currentFile = null;
        let versions = [];
        let activeSidebar = 'explorer';
        let terminalHistory = [];
        let terminalHistoryIndex = 0;
        let isDebugging = false;
        let breakpoints = [];
        let debugVariables = {};
        let settings = {
            fontSize: 14,
            fontFamily: "'Consolas', 'Monaco', monospace",
            autoIndent: true,
            autoSave: false,
            lineNumbers: true,
            minimap: true,
            wordWrap: true,
            terminalAutoScroll: true,
            terminalFontSize: 14,
            terminalMaxLines: 5000,
            theme: 'vs-dark'
        };
        let initializationRetries = 0;
        const maxRetries = 3;
        let searchResults = [];
        let currentDebugTab = 'variables';

        // 代码片段定义
        const snippets = {
            'for-loop': 'for ${1:item} in ${2:iterable}:\n\t${3:pass}',
            'while-loop': 'while ${1:condition}:\n\t${2:pass}',
            'if-else': 'if ${1:condition}:\n\t${2:pass}\nelse:\n\t${3:pass}',
            'function': 'def ${1:function_name}(${2:parameters}):\n\t"""${3:docstring}"""\n\t${4:pass}',
            'class': 'class ${1:ClassName}(${2:ParentClass}):\n\t"""${3:docstring}"""\n\tdef __init__(self${4:parameters}):\n\t\t${5:super().__init__()}\n\t\t${6:pass}',
            'try-except': 'try:\n\t${1:pass}\nexcept ${2:Exception} as e:\n\t${3:pass}\nfinally:\n\t${4:pass}',
            'list-comprehension': '[${1:expression} for ${2:item} in ${3:iterable} if ${4:condition}]',
            'decorator': 'def ${1:decorator_name}(func):\n\tdef wrapper(*args, **kwargs):\n\t\t${2:before}\n\t\tresult = func(*args, **kwargs)\n\t\t${3:after}\n\t\treturn result\n\treturn wrapper',
            'main': 'if __name__ == "__main__":\n\t${1:pass}',
            'import': 'import ${1:module}',
            'lambda': 'lambda ${1:parameters}: ${2:expression}',
            'with': 'with ${1:expression} as ${2:variable}:\n\t${3:pass}'
        };

        // 文件模板
        const fileTemplates = {
            'blank': '',
            'hello': '# Hello World\nprint("Hello, World!")',
            'function': '# Function Example\n\ndef greet(name):\n    """Greet someone"""\n    return f"Hello, {name}!"\n\nif __name__ == "__main__":\n    print(greet("World"))',
            'class': '# Class Example\n\nclass Person:\n    def __init__(self, name, age):\n        self.name = name\n        self.age = age\n    \n    def greet(self):\n        return f"Hello, my name is {self.name} and I am {self.age} years old."\n\nif __name__ == "__main__":\n    person = Person("Alice", 25)\n    print(person.greet())',
            'script': '#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\n"""\nScript description\n"""\n\nimport sys\nimport os\n\ndef main():\n    """Main function"""\n    print("Script started...")\n    # Your code here\n    print("Script finished.")\n\nif __name__ == "__main__":\n    main()',
            'web': '# Web Application Template\n\nfrom flask import Flask, render_template, request\n\napp = Flask(__name__)\n\n@app.route(\'/\')\ndef home():\n    return "Hello, World!"\n\n@app.route(\'/hello/<name>\')\ndef hello(name):\n    return f"Hello, {name}!"\n\nif __name__ == "__main__":\n    app.run(debug=True)',
            'test': '# Test Template\n\nimport unittest\n\nclass TestExample(unittest.TestCase):\n    def test_addition(self):\n        self.assertEqual(1 + 1, 2)\n    \n    def test_subtraction(self):\n        self.assertEqual(5 - 3, 2)\n\nif __name__ == "__main__":\n    unittest.main()'
        };

        // 命令列表
        const commands = [
            { name: '新建文件', action: 'showNewFileDialog', shortcut: 'Ctrl+N', icon: 'fas fa-file-plus' },
            { name: '打开文件', action: 'showImportDialog', shortcut: 'Ctrl+O', icon: 'fas fa-folder-open' },
            { name: '保存文件', action: 'saveVersion', shortcut: 'Ctrl+S', icon: 'fas fa-save' },
            { name: '运行代码', action: 'runCode', shortcut: 'F5', icon: 'fas fa-play' },
            { name: '调试代码', action: 'debugCode', shortcut: 'F6', icon: 'fas fa-bug' },
            { name: '查找替换', action: 'toggleSearchReplace', shortcut: 'Ctrl+F', icon: 'fas fa-search' },
            { name: '格式化代码', action: 'formatCode', shortcut: 'Shift+Alt+F', icon: 'fas fa-align-left' },
            { name: '切换终端', action: 'toggleTerminal', shortcut: 'Ctrl+`', icon: 'fas fa-terminal' },
            { name: '全屏模式', action: 'toggleFullscreen', shortcut: 'F11', icon: 'fas fa-expand' },
            { name: '显示设置', action: 'showSettingsDialog', icon: 'fas fa-cog' },
            { name: '显示快捷键', action: 'showShortcutsDialog', icon: 'fas fa-keyboard' },
            { name: '显示代码片段', action: 'showSnippetsDialog', icon: 'fas fa-code' },
            { name: '导出项目', action: 'exportProject', icon: 'fas fa-download' },
            { name: '分享项目', action: 'shareProject', icon: 'fas fa-share-alt' },
            { name: '撤销', action: 'undo', shortcut: 'Ctrl+Z', icon: 'fas fa-undo' },
            { name: '重做', action: 'redo', shortcut: 'Ctrl+Y', icon: 'fas fa-redo' }
        ];

        // 初始化Monaco Editor
        function initializeMonacoEditor() {
            return new Promise((resolve, reject) => {
                if (typeof require === 'undefined') {
                    reject(new Error('Monaco Editor 加载失败'));
                    return;
                }

                require.config({ 
                    paths: { 
                        vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' 
                    } 
                });
                
                require(['vs/editor/editor.main'], function () {
                    try {
                        editor = monaco.editor.create(document.getElementById('editor'), {
                            value: '# 欢迎使用 Web Python IDE Professional\n# 这是一个功能强大的在线 Python 开发环境\n\nprint("Hello, World!")',
                            language: 'python',
                            theme: settings.theme,
                            automaticLayout: true,
                            fontSize: settings.fontSize,
                            fontFamily: settings.fontFamily,
                            minimap: { enabled: settings.minimap },
                            scrollBeyondLastLine: false,
                            wordWrap: settings.wordWrap ? 'on' : 'off',
                            formatOnPaste: true,
                            formatOnType: true,
                            lineNumbers: settings.lineNumbers ? 'on' : 'off',
                            renderLineHighlight: 'all',
                            selectOnLineNumbers: true,
                            matchBrackets: 'always',
                            autoIndent: settings.autoIndent ? 'advanced' : 'none',
                            glyphMargin: true,
                            lightBulb: { enabled: true },
                            quickSuggestions: {
                                other: true,
                                comments: true,
                                strings: true
                            },
                            suggestOnTriggerCharacters: true,
                            acceptSuggestionOnEnter: 'on',
                            tabCompletion: 'on',
                            wordBasedSuggestions: true,
                            parameterHints: { enabled: true },
                            autoClosingBrackets: 'always',
                            autoClosingQuotes: 'always',
                            folding: true,
                            showFoldingControls: 'always'
                        });

                        // 设置代码补全
                        monaco.languages.registerCompletionItemProvider('python', {
                            provideCompletionItems: function(model, position) {
                                const word = model.getWordUntilPosition(position);
                                const range = {
                                    startLineNumber: position.lineNumber,
                                    endLineNumber: position.lineNumber,
                                    startColumn: word.startColumn,
                                    endColumn: word.endColumn
                                };

                                const suggestions = [
                                    {
                                        label: 'print',
                                        kind: monaco.languages.CompletionItemKind.Function,
                                        insertText: 'print($0)',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '打印输出到控制台',
                                        range: range
                                    },
                                    {
                                        label: 'def',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'def ${1:function_name}(${2:parameters}):\n\t"""${3:docstring}"""\n\t${4:pass}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '定义函数',
                                        range: range
                                    },
                                    {
                                        label: 'class',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'class ${1:ClassName}(${2:ParentClass}):\n\t"""${3:docstring}"""\n\tdef __init__(self${4:parameters}):\n\t\t${5:super().__init__()}\n\t\t${6:pass}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '定义类',
                                        range: range
                                    },
                                    {
                                        label: 'if',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'if ${1:condition}:\n\t${2:pass}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '条件语句',
                                        range: range
                                    },
                                    {
                                        label: 'for',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'for ${1:item} in ${2:iterable}:\n\t${3:pass}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: 'for循环',
                                        range: range
                                    },
                                    {
                                        label: 'while',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'while ${1:condition}:\n\t${2:pass}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: 'while循环',
                                        range: range
                                    },
                                    {
                                        label: 'import',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'import ${1:module}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '导入模块',
                                        range: range
                                    },
                                    {
                                        label: 'try',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'try:\n\t${1:pass}\nexcept ${2:Exception} as e:\n\t${3:pass}\nfinally:\n\t${4:pass}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '异常处理',
                                        range: range
                                    },
                                    {
                                        label: 'with',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'with ${1:expression} as ${2:variable}:\n\t${3:pass}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '上下文管理器',
                                        range: range
                                    },
                                    {
                                        label: 'lambda',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'lambda ${1:parameters}: ${2:expression}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: 'lambda表达式',
                                        range: range
                                    },
                                    {
                                        label: 'return',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'return ${1:value}',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '返回值',
                                        range: range
                                    },
                                    {
                                        label: 'raise',
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: 'raise ${1:Exception}("${2:message}")',
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        documentation: '抛出异常',
                                        range: range
                                    }
                                ];

                                return { suggestions: suggestions };
                            }
                        });

                        // 设置错误诊断
                        monaco.languages.registerDocumentFormattingEditProvider('python', {
                            provideDocumentFormattingEdits: function(model) {
                                return [{
                                    range: model.getFullModelRange(),
                                    text: formatPythonCode(model.getValue())
                                }];
                            }
                        });

                        // 监听内容变化
                        editor.onDidChangeModelContent(() => {
                            if (currentFile && files[currentFile]) {
                                files[currentFile].content = editor.getValue();
                                files[currentFile].modified = true;
                                updateTabTitle(currentFile);
                                
                                // 自动保存
                                if (settings.autoSave) {
                                    clearTimeout(window.autoSaveTimer);
                                    window.autoSaveTimer = setTimeout(() => {
                                        saveVersion('自动保存');
                                    }, 2000);
                                }
                            }
                        });

                        // 监听断点
                        editor.onMouseDown((e) => {
                            if (e.target.position && e.target.type === 'glyphMargin') {
                                toggleBreakpoint(e.target.position.lineNumber);
                            }
                        });

                        // 监听选择变化
                        editor.onDidChangeCursorSelection((e) => {
                            if (e.selection.isEmpty()) {
                                updateStatus(`行 ${e.position.lineNumber}, 列 ${e.position.column}`);
                            } else {
                                const lines = Math.abs(e.selection.endLineNumber - e.selection.startLineNumber) + 1;
                                updateStatus(`已选择 ${lines} 行`);
                            }
                        });

                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }

        // 格式化Python代码
        function formatPythonCode(code) {
            // 简单的代码格式化实现
            return code;
        }

        // 初始化Pyodide
        async function initializePyodide() {
            try {
                if (typeof loadPyodide === 'undefined') {
                    throw new Error('Pyodide 加载失败');
                }

                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/",
                    fullStdLib: false
                });

                // 设置Python环境
                await pyodide.runPythonAsync(`
import sys
import io
import json
import traceback
import time
from contextlib import redirect_stdout, redirect_stderr

# 设置输出重定向
class OutputCapture:
    def __init__(self):
        self.outputs = []
    
    def write(self, text):
        self.outputs.append(text)
    
    def flush(self):
        pass
    
    def getvalue(self):
        return ''.join(self.outputs)
    
    def clear(self):
        self.outputs = []

# 全局输出捕获器
stdout_capture = OutputCapture()
stderr_capture = OutputCapture()

def capture_output(func):
    def wrapper(*args, **kwargs):
        stdout_capture.clear()
        stderr_capture.clear()
        
        old_stdout = sys.stdout
        old_stderr = sys.stderr
        
        sys.stdout = stdout_capture
        sys.stderr = stderr_capture
        
        try:
            result = func(*args, **kwargs)
            return result, stdout_capture.getvalue(), stderr_capture.getvalue()
        except Exception as e:
            return None, stdout_capture.getvalue(), str(e)
        finally:
            sys.stdout = old_stdout
            sys.stderr = old_stderr
    
    return wrapper

# 添加常用函数到全局命名空间
def help():
    return """Web Python IDE Professional 帮助信息

可用命令:
  help()     - 显示此帮助信息
  clear()    - 清空终端
  run()      - 运行当前文件
  files()    - 列出所有文件
  save(name) - 保存当前文件
  load(name) - 加载文件
  time()     - 显示当前时间
  sys()      - 显示系统信息

快捷键:
  F5         - 运行代码
  F6         - 调试代码
  Ctrl+S     - 保存文件
  Ctrl+O     - 打开文件
  Ctrl+F     - 查找替换
"""

def clear():
    global stdout_capture, stderr_capture
    stdout_capture.clear()
    stderr_capture.clear()
    return "终端已清空"

def run():
    global current_file_content
    if current_file_content:
        exec(current_file_content)
        return "代码执行完成"
    return "没有可执行的代码"

def files():
    return list(file_registry.keys()) if 'file_registry' in globals() else []

def time():
    import time
    return time.strftime("%Y-%m-%d %H:%M:%S")

def sys():
    import sys
    import platform
    return f"""
系统信息:
  Python版本: {sys.version}
  平台: {platform.platform()}
  处理器: {platform.processor()}
"""

# 初始化文件注册表
file_registry = {}
current_file_content = ""

# 添加一些常用的库
import math
import random
import datetime
import re
                `);

                // 创建默认文件
                createDefaultFile();

            } catch (error) {
                console.error('Pyodide初始化失败:', error);
                throw new Error('Python环境初始化失败: ' + error.message);
            }
        }

        // 更新加载进度
        function updateLoadingProgress(percent, step, text) {
            document.getElementById('loadingProgressBar').style.width = percent + '%';
            document.getElementById('loadingText').textContent = text;
            
            // 更新步骤状态
            if (step) {
                document.getElementById(step).classList.add('active');
                if (step === 'step4') {
                    document.querySelectorAll('.loading-step').forEach(s => s.classList.add('completed'));
                }
            }
        }

        // 显示错误
        function showError(message, details = '') {
            try {
                const errorContainer = document.getElementById('errorContainer');
                if (errorContainer) {
                    errorContainer.style.display = 'block';
                }
                
                const errorDetails = document.getElementById('errorDetails');
                if (errorDetails) {
                    errorDetails.textContent = message + '\n\n' + details;
                }
                
                const loadingSpinner = document.querySelector('.loading-spinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
                
                // 如果已经显示了主界面，显示通知
                if (document.getElementById('mainApp').style.display === 'block') {
                    showNotification('error', '初始化失败', message + '\n请刷新页面重试');
                }
            } catch (e) {
                console.error('显示错误信息失败:', e);
            }
        }

        // 重试初始化
        function retryInitialization() {
            initializationRetries++;
            document.getElementById('errorContainer').style.display = 'none';
            document.querySelector('.loading-spinner').style.display = 'block';
            document.getElementById('loadingProgressBar').style.width = '0%';
            document.querySelectorAll('.loading-step').forEach(s => s.classList.remove('active', 'completed'));
            
            if (initializationRetries <= maxRetries) {
                initializeApp();
            } else {
                showError('初始化失败次数过多', '请检查网络连接后刷新页面重试。\n\n可能的原因：\n1. 网络连接不稳定\n2. CDN服务暂时不可用\n3. 浏览器不支持WebAssembly');
            }
        }

        // 检查浏览器兼容性
        function checkBrowserCompatibility() {
            const errors = [];
            
            // 检查WebAssembly支持
            if (typeof WebAssembly === 'undefined') {
                errors.push('您的浏览器不支持WebAssembly');
            }
            
            // 检查必要的JavaScript特性
            try {
                new Function('(a = 0) => a');
            } catch (e) {
                errors.push('您的浏览器不支持ES6语法');
            }
            
            // 检查Fetch API
            if (typeof fetch === 'undefined') {
                errors.push('您的浏览器不支持Fetch API');
            }
            
            // 检查Promise
            if (typeof Promise === 'undefined') {
                errors.push('您的浏览器不支持Promise');
            }
            
            return errors;
        }

        // 资源加载管理器
        class ResourceLoader {
            constructor() {
                this.resources = [];
                this.loadedResources = new Set();
                this.callbacks = new Map();
            }

            register(name, priority = 0) {
                this.resources.push({ name, priority });
                this.resources.sort((a, b) => b.priority - a.priority);
            }

            markAsLoaded(name) {
                this.loadedResources.add(name);
                this._triggerCallbacks(name);
            }

            onLoad(name, callback) {
                if (!this.callbacks.has(name)) {
                    this.callbacks.set(name, []);
                }
                this.callbacks.get(name).push(callback);

                // 如果资源已经加载，则立即执行回调
                if (this.loadedResources.has(name)) {
                    callback();
                }
            }

            _triggerCallbacks(name) {
                if (this.callbacks.has(name)) {
                    this.callbacks.get(name).forEach(callback => callback());
                }
            }

            getProgress() {
                return Math.round((this.loadedResources.size / this.resources.length) * 100);
            }
        }

        // 初始化资源加载管理器
        const resourceLoader = new ResourceLoader();
        resourceLoader.register('dom', 10);
        resourceLoader.register('editor', 5);
        resourceLoader.register('python', 3);



        // 初始化应用 - 优化版，先显示界面再加载资源
        async function initializeApp() {
            try {
                // 检查浏览器兼容性
                updateLoadingProgress(10, 'step1', '检查浏览器兼容性...');
                const compatibilityErrors = checkBrowserCompatibility();
                if (compatibilityErrors.length > 0) {
                    showError('浏览器不兼容', compatibilityErrors.join('\n'));
                    return;
                }

                // 立即显示主界面（不等待资源完全加载）
                setTimeout(() => {
                    try {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        showNotification('info', '界面加载完成', '正在后台加载必要资源...');
                        resourceLoader.markAsLoaded('dom');
                    } catch (e) {
                        console.error('显示界面失败:', e);
                    }
                }, 300);

                // 异步加载编辑器
                loadEditorAsync();
                
                // 异步加载Python环境
                loadPythonAsync();
                
            } catch (error) {
                console.error('初始化失败:', error);
                try {
                    showError('初始化失败', error.message + '\n\n请点击重试按钮或刷新页面。');
                } catch (e) {
                    console.error('显示错误信息失败:', e);
                }
            }
        }

        // 异步加载编辑器
        async function loadEditorAsync() {
            try {
                updateLoadingProgress(30, 'step2', '初始化编辑器...');
                await initializeMonacoEditor();
                resourceLoader.markAsLoaded('editor');
                updateStatus('编辑器已就绪');
                showNotification('success', '编辑器加载完成', '您现在可以开始编辑代码了');
            } catch (error) {
                console.error('编辑器加载失败:', error);
                showNotification('error', '编辑器加载失败', error.message, 0);
            }
        }

        // 异步加载Python环境
        async function loadPythonAsync() {
            try {
                updateLoadingProgress(60, 'step3', '加载Python环境...');
                await initializePyodide();
                resourceLoader.markAsLoaded('python');
                updateStatus('Python环境已就绪');
                showNotification('success', 'Python环境加载完成', '您可以运行Python代码了');
                updateLoadingProgress(100, 'step4', '启动完成！');
            } catch (error) {
                console.error('Python环境加载失败:', error);
                showNotification('error', 'Python环境加载失败', error.message + '\n您可以尝试稍后再次加载', 0);
            }
        }

        // 显示通知
        function showNotification(type, title, message = '', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">${title}</div>
                    <div class="notification-close" onclick="this.closest('.notification').remove()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                ${message ? `<div class="notification-message">${message}</div>` : ''}
                ${duration > 0 ? '<div class="notification-progress"></div>' : ''}
            `;
            
            container.appendChild(notification);
            
            // 添加进度条动画
            if (duration > 0) {
                const progressBar = notification.querySelector('.notification-progress');
                progressBar.style.transition = `width ${duration}ms linear`;
                setTimeout(() => progressBar.style.width = '100%', 10);
            }
            
            // 自动移除
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.animation = 'notificationSlideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        // 创建默认文件
        function createDefaultFile() {
            const defaultFileName = 'main.py';
            files[defaultFileName] = {
                name: defaultFileName,
                content: '# 欢迎使用 Web Python IDE Professional\n# 这是一个功能强大的在线 Python 开发环境\n\nprint("Hello, World!")',
                modified: false,
                created: new Date(),
                size: new Blob(['# 欢迎使用 Web Python IDE Professional\n# 这是一个功能强大的在线 Python 开发环境\n\nprint("Hello, World!")']).size
            };
            
            openFile(defaultFileName);
            updateFileTree();
        }

        // 显示新建文件对话框
        function showNewFileDialog() {
            document.getElementById('newFileModal').classList.add('active');
            document.getElementById('newFileName').focus();
        }

        // 创建新文件
        function createNewFile() {
            const fileName = document.getElementById('newFileName').value.trim();
            const template = document.getElementById('fileTemplate').value;
            
            if (!fileName) {
                showNotification('warning', '提示', '请输入文件名');
                return;
            }

            if (!fileName.endsWith('.py')) {
                showNotification('warning', '提示', '文件名必须以.py结尾');
                return;
            }

            if (files[fileName]) {
                showNotification('warning', '提示', '文件已存在');
                return;
            }

            const content = fileTemplates[template] || '';
            files[fileName] = {
                name: fileName,
                content: content,
                modified: false,
                created: new Date(),
                size: new Blob([content]).size
            };

            openFile(fileName);
            updateFileTree();
            closeModal('newFileModal');
            document.getElementById('newFileName').value = '';
            document.getElementById('fileTemplate').value = 'blank';
            showNotification('success', '成功', `文件 ${fileName} 创建成功`);
        }

        // 显示新建文件夹对话框
        function showNewFolderDialog() {
            document.getElementById('newFolderModal').classList.add('active');
            document.getElementById('newFolderName').focus();
        }

        // 创建新文件夹
        function createNewFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();
            
            if (!folderName) {
                showNotification('warning', '提示', '请输入文件夹名称');
                return;
            }

            if (folders[folderName]) {
                showNotification('warning', '提示', '文件夹已存在');
                return;
            }

            folders[folderName] = {
                name: folderName,
                files: [],
                created: new Date()
            };

            updateFileTree();
            closeModal('newFolderModal');
            document.getElementById('newFolderName').value = '';
            showNotification('success', '成功', `文件夹 ${folderName} 创建成功`);
        }

        // 打开文件
        function openFile(fileName) {
            currentFile = fileName;
            const file = files[fileName];
            
            if (file) {
                editor.setValue(file.content);
                updateTabs();
                updateTabTitle(fileName);
                updateStatus(`已打开: ${fileName}`);
                
                // 更新Python环境中的当前文件内容
                if (pyodide) {
                    pyodide.runPython(`current_file_content = """${file.content.replace(/"/g, '\\"').replace(/\n/g, '\\n')}"""`);
                    pyodide.runPython(`file_registry["${fileName}"] = current_file_content`);
                }
            }
        }

        // 更新标签页
        function updateTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            const addBtn = tabsContainer.querySelector('.tab-add');
            tabsContainer.innerHTML = '';
            
            for (const fileName in files) {
                const tab = document.createElement('div');
                tab.className = 'tab';
                if (fileName === currentFile) {
                    tab.classList.add('active');
                }
                if (files[fileName].modified) {
                    tab.classList.add('dirty');
                }
                
                tab.innerHTML = `
                    <div class="tab-content">
                        <i class="fab fa-python tab-icon"></i>
                        <span class="tab-title">${fileName}</span>
                    </div>
                    <div class="tab-close" onclick="closeFile('${fileName}')">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                
                tab.onclick = (e) => {
                    if (!e.target.closest('.tab-close')) {
                        openFile(fileName);
                    }
                };
                
                tabsContainer.appendChild(tab);
            }
            
            tabsContainer.appendChild(addBtn);
        }

        // 更新标签标题
        function updateTabTitle(fileName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes(fileName)) {
                    if (files[fileName].modified) {
                        tab.classList.add('dirty');
                    } else {
                        tab.classList.remove('dirty');
                    }
                }
            });
        }

        // 关闭文件
        function closeFile(fileName) {
            if (files[fileName].modified) {
                if (!confirm('文件已修改，确定要关闭吗？')) {
                    return;
                }
            }

            delete files[fileName];
            
            if (currentFile === fileName) {
                const fileNames = Object.keys(files);
                if (fileNames.length > 0) {
                    openFile(fileNames[0]);
                } else {
                    currentFile = null;
                    editor.setValue('');
                }
            }
            
            updateTabs();
            updateFileTree();
        }

        // 更新文件树
        function updateFileTree() {
            const fileTree = document.getElementById('fileTree');
            fileTree.innerHTML = '';

            // 显示文件夹
            for (const folderName in folders) {
                const folderItem = document.createElement('div');
                folderItem.className = 'file-item';
                folderItem.innerHTML = `
                    <i class="fas fa-folder file-icon" style="color: #d7ba7d;"></i>
                    <span class="file-name">${folderName}</span>
                `;
                fileTree.appendChild(folderItem);
            }

            // 显示文件
            for (const fileName in files) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                if (fileName === currentFile) {
                    fileItem.classList.add('active');
                }
                if (files[fileName].modified) {
                    fileItem.classList.add('modified');
                }
                
                const fileSize = formatFileSize(files[fileName].size);
                
                fileItem.innerHTML = `
                    <i class="fab fa-python file-icon" style="color: #4ec9b0;"></i>
                    <span class="file-name">${fileName}</span>
                    <span class="file-size">${fileSize}</span>
                `;
                
                fileItem.onclick = (e) => {
                    if (e.button === 0) { // 左键
                        openFile(fileName);
                    }
                };
                
                fileItem.oncontextmenu = (e) => {
                    e.preventDefault();
                    showContextMenu(e, fileName);
                };
                
                fileTree.appendChild(fileItem);
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 刷新文件树
        function refreshFileTree() {
            updateFileTree();
            showNotification('info', '刷新', '文件树已刷新');
        }

        // 显示右键菜单
        function showContextMenu(event, fileName) {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            // 存储当前选中的文件
            contextMenu.setAttribute('data-file', fileName);
            
            // 点击其他地方关闭菜单
            document.addEventListener('click', hideContextMenu);
        }

        // 隐藏右键菜单
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
        }

        // 重命名文件
        function renameFile() {
            const contextMenu = document.getElementById('contextMenu');
            const fileName = contextMenu.getAttribute('data-file');
            const newName = prompt('请输入新的文件名:', fileName);
            
            if (newName && newName !== fileName && newName.endsWith('.py')) {
                files[newName] = {...files[fileName], name: newName};
                delete files[fileName];
                
                if (currentFile === fileName) {
                    currentFile = newName;
                }
                
                updateTabs();
                updateFileTree();
                showNotification('success', '成功', `文件已重命名为 ${newName}`);
            }
            
            hideContextMenu();
        }

        // 复制文件
        function duplicateFile() {
            const contextMenu = document.getElementById('contextMenu');
            const fileName = contextMenu.getAttribute('data-file');
            const copyName = fileName.replace('.py', '_copy.py');
            
            files[copyName] = {
                ...files[fileName],
                name: copyName,
                modified: true,
                created: new Date()
            };
            
            updateTabs();
            updateFileTree();
            showNotification('success', '成功', `文件已复制为 ${copyName}`);
            
            hideContextMenu();
        }

        // 删除文件
        function deleteFile() {
            const contextMenu = document.getElementById('contextMenu');
            const fileName = contextMenu.getAttribute('data-file');
            
            if (confirm(`确定要删除文件 ${fileName} 吗？`)) {
                delete files[fileName];
                
                if (currentFile === fileName) {
                    const fileNames = Object.keys(files);
                    if (fileNames.length > 0) {
                        openFile(fileNames[0]);
                    } else {
                        currentFile = null;
                        editor.setValue('');
                    }
                }
                
                updateTabs();
                updateFileTree();
                showNotification('success', '成功', `文件 ${fileName} 已删除`);
            }
            
            hideContextMenu();
        }

        // 显示导入对话框
        function showImportDialog() {
            document.getElementById('importModal').classList.add('active');
        }

        // 导入多个文件
        function importFiles() {
            const fileInput = document.getElementById('importFile');
            const fileList = fileInput.files;
            
            if (fileList.length === 0) {
                showNotification('warning', '提示', '请选择要导入的文件');
                return;
            }

            let importedCount = 0;
            let skippedCount = 0;
            
            Array.from(fileList).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileName = file.name;
                    if (fileName.endsWith('.py') || fileName.endsWith('.txt') || 
                        fileName.endsWith('.json') || fileName.endsWith('.csv') ||
                        fileName.endsWith('.md') || fileName.endsWith('.html') ||
                        fileName.endsWith('.css') || fileName.endsWith('.js')) {
                        if (!files[fileName]) {
                            files[fileName] = {
                                name: fileName,
                                content: e.target.result,
                                modified: false,
                                created: new Date(),
                                size: file.size
                            };
                            importedCount++;
                        } else {
                            skippedCount++;
                        }
                    } else {
                        skippedCount++;
                    }
                    
                    if (importedCount + skippedCount === fileList.length) {
                        updateFileTree();
                        closeModal('importModal');
                        let message = `已导入 ${importedCount} 个文件`;
                        if (skippedCount > 0) {
                            message += `，跳过 ${skippedCount} 个文件`;
                        }
                        showNotification('success', '导入完成', message);
                    }
                };
                reader.readAsText(file);
            });
        }

        // 显示导入项目对话框
        function showImportProjectDialog() {
            document.getElementById('importProjectModal').classList.add('active');
        }

        // 导入项目
        function importProject() {
            const fileInput = document.getElementById('importProjectFile');
            const fileList = fileInput.files;
            const projectName = document.getElementById('projectName').value.trim() || '导入的项目';
            
            if (fileList.length === 0) {
                showNotification('warning', '提示', '请选择要导入的项目文件夹');
                return;
            }

            // 创建项目文件夹
            folders[projectName] = {
                name: projectName,
                files: [],
                created: new Date()
            };

            let importedCount = 0;
            
            Array.from(fileList).forEach(file => {
                if (file.name.endsWith('.py')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const fileName = `${projectName}/${file.name}`;
                        files[fileName] = {
                            name: fileName,
                            content: e.target.result,
                            modified: false,
                            created: new Date(),
                            size: file.size
                        };
                        folders[projectName].files.push(file.name);
                        importedCount++;
                        
                        if (importedCount === Array.from(fileList).filter(f => f.name.endsWith('.py')).length) {
                            updateFileTree();
                            closeModal('importProjectModal');
                            showNotification('success', '导入完成', `项目 "${projectName}" 已导入，共 ${importedCount} 个Python文件`);
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }

        // 导出当前文件
        function exportCurrentFile() {
            if (!currentFile) {
                showNotification('warning', '提示', '没有打开的文件');
                return;
            }

            const file = files[currentFile];
            const blob = new Blob([file.content], { type: 'text/plain' });
            saveAs(blob, currentFile);
            showNotification('success', '成功', `文件 ${currentFile} 已导出`);
        }

        // 导出项目
        function exportProject() {
            if (Object.keys(files).length === 0) {
                showNotification('warning', '提示', '没有可导出的文件');
                return;
            }

            const zip = new JSZip();
            
            for (const fileName in files) {
                zip.file(fileName, files[fileName].content);
            }
            
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                saveAs(content, 'python_project.zip');
                showNotification('success', '成功', '项目已导出为ZIP文件');
            });
        }

        // 分享项目
        function shareProject() {
            if (Object.keys(files).length === 0) {
                showNotification('warning', '提示', '没有可分享的文件');
                return;
            }

            const projectData = {
                files: files,
                versions: versions,
                settings: settings,
                timestamp: new Date().toISOString()
            };
            
            const encoded = btoa(JSON.stringify(projectData));
            const shareUrl = `${window.location.origin}${window.location.pathname}#share=${encoded}`;
            
            // 创建分享对话框
            const shareModal = document.createElement('div');
            shareModal.className = 'modal active';
            shareModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">分享项目</div>
                        <div class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px;">复制以下链接分享您的项目：</p>
                        <input type="text" class="form-control" value="${shareUrl}" readonly onclick="this.select()">
                        <div style="margin-top: 15px; padding: 15px; background-color: rgba(0, 122, 204, 0.1); border-radius: 5px;">
                            <h4 style="margin-bottom: 10px; color: var(--info-color);">分享说明：</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #969696; font-size: 13px;">
                                <li>链接包含所有文件和版本信息</li>
                                <li>接收者可以通过链接直接打开项目</li>
                                <li>链接有效期永久</li>
                                <li>包含您的编辑器设置</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">关闭</button>
                        <button class="btn btn-primary" onclick="
                            navigator.clipboard.writeText('${shareUrl}'); 
                            this.textContent='已复制!'; 
                            setTimeout(() => this.textContent='复制链接', 2000)
                        ">复制链接</button>
                    </div>
                </div>
            `;
            document.body.appendChild(shareModal);
        }

        // 分享文件
        function shareFile() {
            if (!currentFile) {
                showNotification('warning', '提示', '没有打开的文件');
                return;
            }

            const fileData = {
                name: currentFile,
                content: files[currentFile].content,
                timestamp: new Date().toISOString()
            };
            
            const encoded = btoa(JSON.stringify(fileData));
            const shareUrl = `${window.location.origin}${window.location.pathname}#file=${encoded}`;
            
            // 创建分享对话框
            const shareModal = document.createElement('div');
            shareModal.className = 'modal active';
            shareModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">分享文件</div>
                        <div class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px;">复制以下链接分享您的文件：</p>
                        <input type="text" class="form-control" value="${shareUrl}" readonly onclick="this.select()">
                        <div style="margin-top: 15px; padding: 10px; background-color: rgba(0, 122, 204, 0.1); border-radius: 5px;">
                            <strong style="color: var(--info-color);">文件：</strong> ${currentFile}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">关闭</button>
                        <button class="btn btn-primary" onclick="
                            navigator.clipboard.writeText('${shareUrl}'); 
                            this.textContent='已复制!'; 
                            setTimeout(() => this.textContent='复制链接', 2000)
                        ">复制链接</button>
                    </div>
                </div>
            `;
            document.body.appendChild(shareModal);
        }

        // 运行代码
        async function runCode() {
            if (!currentFile) {
                showNotification('warning', '提示', '没有打开的文件');
                return;
            }

            const code = editor.getValue();
            if (!code.trim()) {
                showNotification('warning', '提示', '没有代码可运行');
                return;
            }

            updateStatus('运行中...');
            addTerminalOutput('正在运行代码...', 'info');

            try {
                // 重定向输出
                pyodide.runPython(`
stdout_capture.clear()
stderr_capture.clear()
                `);

                // 运行用户代码
                await pyodide.runPythonAsync(code);

                // 获取输出
                const stdout = pyodide.runPython('stdout_capture.getvalue()');
                const stderr = pyodide.runPython('stderr_capture.getvalue()');

                if (stdout) {
                    addTerminalOutput(stdout, 'output');
                }
                if (stderr) {
                    addTerminalOutput(stderr, 'error');
                }

                updateStatus('运行完成');
            } catch (error) {
                addTerminalOutput('运行错误: ' + error.message, 'error');
                updateStatus('运行错误');
            }
        }

        // 运行选中的代码
        async function runSelection() {
            const selection = editor.getSelection();
            if (selection.isEmpty()) {
                runCode();
                return;
            }

            const code = editor.getModel().getValueInRange(selection);
            if (!code.trim()) {
                showNotification('warning', '提示', '没有选中的代码');
                return;
            }

            updateStatus('运行选中代码...');
            addTerminalOutput('正在运行选中代码...', 'info');

            try {
                pyodide.runPython(`
stdout_capture.clear()
stderr_capture.clear()
                `);

                await pyodide.runPythonAsync(code);

                const stdout = pyodide.runPython('stdout_capture.getvalue()');
                const stderr = pyodide.runPython('stderr_capture.getvalue()');

                if (stdout) {
                    addTerminalOutput(stdout, 'output');
                }
                if (stderr) {
                    addTerminalOutput(stderr, 'error');
                }

                updateStatus('运行完成');
            } catch (error) {
                addTerminalOutput('运行错误: ' + error.message, 'error');
                updateStatus('运行错误');
            }
        }

        // 调试代码
        function debugCode() {
            if (!currentFile) {
                showNotification('warning', '提示', '没有打开的文件');
                return;
            }

            isDebugging = !isDebugging;
            
            if (isDebugging) {
                updateStatus('调试中...');
                toggleDebugPanel();
                document.getElementById('debugStatus').textContent = '调试中';
                showNotification('info', '调试模式', '调试模式已启用，点击行号设置断点');
            } else {
                updateStatus('就绪');
                document.getElementById('debugStatus').textContent = '未调试';
                showNotification('info', '调试模式', '调试模式已关闭');
            }
        }

        // 停止执行
        function stopExecution() {
            if (pyodide) {
                // 由于Pyodide的限制，这里只是更新状态
                showNotification('info', '提示', '执行已停止');
                updateStatus('就绪');
                document.getElementById('debugStatus').textContent = '未调试';
                isDebugging = false;
            }
        }

        // 切换断点
        function toggleBreakpoint(lineNumber) {
            const index = breakpoints.indexOf(lineNumber);
            if (index > -1) {
                breakpoints.splice(index, 1);
            } else {
                breakpoints.push(lineNumber);
            }
            
            // 更新编辑器显示
            const model = editor.getModel();
            const decorations = breakpoints.map(line => ({
                range: new monaco.Range(line, 1, line, 1),
                options: {
                    isWholeLine: true,
                    className: 'breakpoint-decoration',
                    glyphMarginClassName: 'breakpoint-glyph'
                }
            }));
            
            editor.deltaDecorations([], decorations);
        }

        // 切换调试标签
        function switchDebugTab(tab) {
            currentDebugTab = tab;
            document.querySelectorAll('.debug-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = '';
            
            switch (tab) {
                case 'variables':
                    updateDebugVariables();
                    break;
                case 'watch':
                    debugContent.innerHTML = '<div style="padding: 20px; color: #969696; text-align: center;">监视功能开发中...</div>';
                    break;
                case 'callstack':
                    debugContent.innerHTML = '<div style="padding: 20px; color: #969696; text-align: center;">调用堆栈功能开发中...</div>';
                    break;
                case 'breakpoints':
                    updateBreakpointsList();
                    break;
            }
        }

        // 更新调试变量
        function updateDebugVariables() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = '';
            
            if (Object.keys(debugVariables).length === 0) {
                debugContent.innerHTML = '<div style="padding: 20px; color: #969696; text-align: center;">没有可显示的变量</div>';
                return;
            }
            
            for (const [name, value] of Object.entries(debugVariables)) {
                const variableDiv = document.createElement('div');
                variableDiv.className = 'debug-variable';
                variableDiv.innerHTML = `
                    <span class="debug-variable-name">${name}</span>
                    <span class="debug-variable-type">${typeof value}</span>
                    <span class="debug-variable-value">${String(value)}</span>
                `;
                debugContent.appendChild(variableDiv);
            }
        }

        // 更新断点列表
        function updateBreakpointsList() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = '';
            
            if (breakpoints.length === 0) {
                debugContent.innerHTML = '<div style="padding: 20px; color: #969696; text-align: center;">没有设置断点</div>';
                return;
            }
            
            breakpoints.forEach((line, index) => {
                const breakpointDiv = document.createElement('div');
                breakpointDiv.className = 'debug-variable';
                breakpointDiv.innerHTML = `
                    <span class="debug-variable-name">断点 ${index + 1}</span>
                    <span class="debug-variable-type">行 ${line}</span>
                    <span class="debug-variable-value">
                        <i class="fas fa-trash" style="cursor: pointer;" onclick="removeBreakpoint(${line})"></i>
                    </span>
                `;
                debugContent.appendChild(breakpointDiv);
            });
        }

        // 移除断点
        function removeBreakpoint(lineNumber) {
            const index = breakpoints.indexOf(lineNumber);
            if (index > -1) {
                breakpoints.splice(index, 1);
                toggleBreakpoint(lineNumber); // 更新显示
                updateBreakpointsList();
            }
        }

        // 清除调试变量
        function clearDebugVariables() {
            debugVariables = {};
            updateDebugVariables();
            showNotification('info', '清除', '调试变量已清除');
        }

        // 保存版本
        function saveVersion(message = '') {
            if (!currentFile) {
                showNotification('warning', '提示', '没有打开的文件');
                return;
            }

            if (!message) {
                document.getElementById('saveVersionModal').classList.add('active');
                return;
            }

            const version = {
                id: Date.now(),
                fileName: currentFile,
                content: files[currentFile].content,
                message: message,
                description: document.getElementById('versionDescription').value || '',
                tags: document.getElementById('versionTags').value.split(',').map(t => t.trim()).filter(t => t),
                timestamp: new Date()
            };

            versions.push(version);
            updateVersionHistory();
            updateVersionCount();
            closeModal('saveVersionModal');
            document.getElementById('versionMessage').value = '';
            document.getElementById('versionDescription').value = '';
            document.getElementById('versionTags').value = '';
            showNotification('success', '成功', `版本已保存: ${message}`);
        }

        // 保存当前版本
        function saveCurrentVersion() {
            const message = document.getElementById('versionMessage').value.trim() || '未命名版本';
            saveVersion(message);
        }

        // 更新版本历史
        function updateVersionHistory() {
            const versionHistory = document.getElementById('versionHistory');
            versionHistory.innerHTML = '';

            versions.slice().reverse().forEach(version => {
                const versionItem = document.createElement('div');
                versionItem.className = 'version-item';
                versionItem.innerHTML = `
                    <div class="version-header">
                        <div class="version-message">${version.message}</div>
                        <div class="version-time">${formatTime(version.timestamp)}</div>
                    </div>
                    <div class="version-details">
                        ${version.description ? `<div>描述: ${version.description}</div>` : ''}
                        ${version.tags.length > 0 ? `<div>标签: ${version.tags.join(', ')}</div>` : ''}
                        <div>文件: ${version.fileName}</div>
                    </div>
                    <div class="version-actions">
                        <div class="version-action" onclick="restoreVersion(${version.id})" title="恢复此版本">
                            <i class="fas fa-undo"></i>
                        </div>
                        <div class="version-action" onclick="viewVersion(${version.id})" title="查看版本">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="version-action" onclick="deleteVersion(${version.id})" title="删除版本">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                `;
                
                versionHistory.appendChild(versionItem);
            });
        }

        // 刷新版本历史
        function refreshVersionHistory() {
            updateVersionHistory();
            showNotification('info', '刷新', '版本历史已刷新');
        }

        // 恢复版本
        function restoreVersion(versionId) {
            const version = versions.find(v => v.id === versionId);
            if (version) {
                if (confirm(`确定要恢复到版本 "${version.message}" 吗？`)) {
                    files[version.fileName].content = version.content;
                    if (currentFile === version.fileName) {
                        editor.setValue(version.content);
                    }
                    showNotification('success', '成功', `已恢复到版本: ${version.message}`);
                }
            }
        }

        // 查看版本
        function viewVersion(versionId) {
            const version = versions.find(v => v.id === versionId);
            if (version) {
                const viewModal = document.createElement('div');
                viewModal.className = 'modal active';
                viewModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">查看版本: ${version.message}</div>
                            <div class="modal-close" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 15px;">
                                <div><strong>文件:</strong> ${version.fileName}</div>
                                <div><strong>时间:</strong> ${formatTime(version.timestamp)}</div>
                                ${version.description ? `<div><strong>描述:</strong> ${version.description}</div>` : ''}
                                ${version.tags.length > 0 ? `<div><strong>标签:</strong> ${version.tags.join(', ')}</div>` : ''}
                            </div>
                            <textarea class="form-control" readonly style="height: 400px; font-family: 'Consolas', monospace;">${version.content}</textarea>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">关闭</button>
                            <button class="btn btn-primary" onclick="restoreVersion(${version.id}); this.closest('.modal').remove()">恢复此版本</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(viewModal);
            }
        }

        // 删除版本
        function deleteVersion(versionId) {
            const version = versions.find(v => v.id === versionId);
            if (version && confirm(`确定要删除版本 "${version.message}" 吗？`)) {
                versions = versions.filter(v => v.id !== versionId);
                updateVersionHistory();
                updateVersionCount();
                showNotification('success', '成功', '版本已删除');
            }
        }

        // 更新版本计数
        function updateVersionCount() {
            const count = versions.length;
            document.getElementById('versionCount').textContent = `${count} 版本`;
            const badge = document.getElementById('versionBadge');
            if (count > 0) {
                badge.style.display = 'block';
                badge.textContent = count;
            } else {
                badge.style.display = 'none';
            }
        }

        // 格式化时间
        function formatTime(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 切换侧边栏
        function toggleSidebar(panel) {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            const activityIcons = document.querySelectorAll('.activity-icon');
            
            // 更新活动图标状态
            activityIcons.forEach(icon => icon.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // 隐藏所有面板
            document.querySelectorAll('.sidebar-panel').forEach(p => p.style.display = 'none');
            
            // 显示选中的面板
            if (panel === 'explorer') {
                document.getElementById('explorer-panel').style.display = 'flex';
                sidebar.classList.add('active');
                mainContainer.classList.add('sidebar-open');
                activeSidebar = 'explorer';
            } else if (panel === 'search') {
                document.getElementById('search-panel').style.display = 'flex';
                sidebar.classList.add('active');
                mainContainer.classList.add('sidebar-open');
                activeSidebar = 'search';
            } else if (panel === 'git') {
                document.getElementById('git-panel').style.display = 'flex';
                sidebar.classList.add('active');
                mainContainer.classList.add('sidebar-open');
                activeSidebar = 'git';
                updateVersionHistory();
            } else if (panel === 'debug') {
                document.getElementById('debug-panel').style.display = 'flex';
                sidebar.classList.add('active');
                mainContainer.classList.add('sidebar-open');
                activeSidebar = 'debug';
                updateDebugVariables();
            } else if (panel === 'extensions') {
                document.getElementById('extensions-panel').style.display = 'flex';
                sidebar.classList.add('active');
                mainContainer.classList.add('sidebar-open');
                activeSidebar = 'extensions';
                updateExtensionsList();
            } else {
                sidebar.classList.remove('active');
                mainContainer.classList.remove('sidebar-open');
            }
        }

        // 切换侧边栏宽度
        function toggleSidebarWidth() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            
            sidebar.classList.toggle('expanded');
            mainContainer.classList.toggle('sidebar-expanded');
        }

        // 切换终端
        function toggleTerminal() {
            const terminalContainer = document.getElementById('terminalContainer');
            terminalContainer.classList.toggle('minimized');
        }

        // 新建终端
        function newTerminal() {
            showNotification('info', '提示', '多终端功能开发中...');
        }

        // 最小化终端
        function minimizeTerminal() {
            const terminalContainer = document.getElementById('terminalContainer');
            terminalContainer.classList.add('minimized');
        }

        // 最大化终端
        function maximizeTerminal() {
            const terminalContainer = document.getElementById('terminalContainer');
            terminalContainer.classList.toggle('maximized');
        }

        // 关闭终端
        function closeTerminal() {
            const terminalContainer = document.getElementById('terminalContainer');
            terminalContainer.style.display = 'none';
        }

        // 切换调试面板
        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('active');
        }

        // 更新扩展列表
        function updateExtensionsList() {
            const extensionsList = document.getElementById('extensionsList');
            extensionsList.innerHTML = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: var(--info-color); margin-bottom: 10px;">已安装扩展</h3>
                        <div style="color: #969696; font-size: 13px;">暂无已安装的扩展</div>
                    </div>
                    <div>
                        <h3 style="color: var(--info-color); margin-bottom: 10px;">推荐扩展</h3>
                        <div style="color: #969696; font-size: 13px;">扩展市场功能开发中...</div>
                    </div>
                </div>
            `;
        }

        // 刷新扩展
        function refreshExtensions() {
            updateExtensionsList();
            showNotification('info', '刷新', '扩展列表已刷新');
        }

        // 安装扩展
        function installExtension() {
            showNotification('info', '提示', '扩展安装功能开发中...');
        }

        // 切换搜索替换
        function toggleSearchReplace() {
            const searchReplaceBar = document.getElementById('searchReplaceBar');
            searchReplaceBar.classList.toggle('active');
            
            if (searchReplaceBar.classList.contains('active')) {
                document.getElementById('searchInput').focus();
            }
        }

        // 查找下一个
        function findNext() {
            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput.value;
            
            if (searchText) {
                editor.getAction('actions.find').run();
            }
        }

        // 查找上一个
        function findPrevious() {
            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput.value;
            
            if (searchText) {
                editor.getAction('actions.findPrevious').run();
            }
        }

        // 替换
        function replace() {
            const searchInput = document.getElementById('searchInput');
            const replaceInput = document.getElementById('replaceInput');
            const searchText = searchInput.value;
            const replaceText = replaceInput.value;
            
            if (searchText) {
                editor.getAction('editor.action.replace').run();
            }
        }

        // 替换全部
        function replaceAll() {
            const searchInput = document.getElementById('searchInput');
            const replaceInput = document.getElementById('replaceInput');
            const searchText = searchInput.value;
            const replaceText = replaceInput.value;
            
            if (searchText) {
                editor.getAction('editor.action.replaceAll').run();
            }
        }

        // 执行搜索
        function performSearch(query) {
            if (!query) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            searchResults = [];
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div style="padding: 15px; color: #969696;">搜索中...</div>';

            setTimeout(() => {
                for (const fileName in files) {
                    const content = files[fileName].content;
                    const lines = content.split('\n');
                    
                    lines.forEach((line, index) => {
                        if (line.toLowerCase().includes(query.toLowerCase())) {
                            searchResults.push({
                                fileName: fileName,
                                lineNumber: index + 1,
                                line: line.trim(),
                                match: line.toLowerCase().indexOf(query.toLowerCase())
                            });
                        }
                    });
                }

                // 按匹配位置排序
                searchResults.sort((a, b) => a.match - b.match);

                // 显示结果
                if (searchResults.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 15px; color: #969696;">没有找到匹配的结果</div>';
                } else {
                    resultsContainer.innerHTML = searchResults.map(result => `
                        <div class="search-result-item" style="padding: 10px 15px; border-bottom: 1px solid var(--quaternary-color); cursor: pointer;" onclick="openSearchResult('${result.fileName}', ${result.lineNumber})">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="color: var(--info-color); font-weight: 500;">${result.fileName}</span>
                                <span style="color: #969696; font-size: 11px;">第 ${result.lineNumber} 行</span>
                            </div>
                            <div style="color: var(--text-color); font-size: 12px; font-family: 'Consolas', monospace;">${highlightMatch(result.line, query)}</div>
                        </div>
                    `).join('');
                }
            }, 100);
        }

        // 高亮匹配文本
        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background-color: var(--warning-color); color: var(--secondary-color);">$1</mark>');
        }

        // 打开搜索结果
        function openSearchResult(fileName, lineNumber) {
            openFile(fileName);
            editor.revealLineInCenter(lineNumber);
            editor.setPosition({ lineNumber: lineNumber, column: 1 });
            editor.focus();
        }

        // 清除搜索结果
        function clearSearchResults() {
            document.getElementById('searchResults').innerHTML = '';
            document.querySelector('#search-panel input').value = '';
            searchResults = [];
        }

        // 显示代码片段对话框
        function showSnippetsDialog() {
            document.getElementById('snippetsModal').classList.add('active');
        }

        // 插入代码片段
        function insertSnippet(snippetId) {
            const snippet = snippets[snippetId];
            if (snippet) {
                const selection = editor.getSelection();
                const range = new monaco.Range(
                    selection.startLineNumber,
                    selection.startColumn,
                    selection.endLineNumber,
                    selection.endColumn
                );
                
                const operation = {
                    range: range,
                    text: snippet
                };
                
                editor.executeEdits('insert-snippet', [operation]);
                closeModal('snippetsModal');
                showNotification('success', '成功', '代码片段已插入');
            }
        }

        // 格式化代码
        function formatCode() {
            editor.getAction('editor.action.formatDocument').run();
            showNotification('success', '成功', '代码已格式化');
        }

        // 撤销
        function undo() {
            editor.getAction('undo').run();
        }

        // 重做
        function redo() {
            editor.getAction('redo').run();
        }

        // 显示设置对话框
        function showSettingsDialog() {
            document.getElementById('settingsModal').classList.add('active');
        }

        // 显示主题对话框
        function showThemeDialog() {
            showNotification('info', '提示', '主题设置功能已集成到设置中');
            showSettingsDialog();
        }

        // 显示快捷键对话框
        function showShortcutsDialog() {
            document.getElementById('shortcutsModal').classList.add('active');
        }

        // 显示扩展对话框
        function showExtensionsDialog() {
            toggleSidebar('extensions');
        }

        // 显示Git设置
        function showGitSettings() {
            showNotification('info', '提示', '版本控制设置功能开发中...');
        }

        // 显示文档
        function showDocumentation() {
            showNotification('info', '提示', '文档功能开发中...');
        }

        // 显示关于对话框
        function showAboutDialog() {
            document.getElementById('aboutModal').classList.add('active');
        }

        // 更新字体大小
        function updateFontSize(size) {
            settings.fontSize = parseInt(size);
            document.getElementById('fontSizeValue').textContent = size + 'px';
            document.getElementById('fontSizeText').textContent = size + 'px';
            
            if (editor) {
                editor.updateOptions({ fontSize: settings.fontSize });
            }
        }

        // 更新字体族
        function updateFontFamily(family) {
            settings.fontFamily = family;
            
            if (editor) {
                editor.updateOptions({ fontFamily: settings.fontFamily });
            }
        }

        // 更新终端字体大小
        function updateTerminalFontSize(size) {
            settings.terminalFontSize = parseInt(size);
            document.getElementById('terminalFontSizeValue').textContent = size + 'px';
            
            const terminalOutput = document.getElementById('terminalOutput');
            const terminalInput = document.getElementById('terminalInput');
            terminalOutput.style.fontSize = size + 'px';
            terminalInput.style.fontSize = size + 'px';
        }

        // 更新终端最大行数
        function updateTerminalMaxLines(maxLines) {
            settings.terminalMaxLines = parseInt(maxLines);
        }

        // 更新主题
        function updateTheme(theme) {
            settings.theme = theme;
            if (editor) {
                editor.updateOptions({ theme: theme });
            }
        }

        // 切换开关
        function toggleSwitch(element) {
            element.classList.toggle('active');
            
            const settingId = element.id.replace('Switch', '');
            settings[settingId] = element.classList.contains('active');
            
            // 应用设置
            if (editor && settingId === 'lineNumbers') {
                editor.updateOptions({ lineNumbers: settings.lineNumbers ? 'on' : 'off' });
            } else if (editor && settingId === 'minimap') {
                editor.updateOptions({ minimap: { enabled: settings.minimap } });
            } else if (editor && settingId === 'autoIndent') {
                editor.updateOptions({ autoIndent: settings.autoIndent ? 'advanced' : 'none' });
            } else if (editor && settingId === 'wordWrap') {
                editor.updateOptions({ wordWrap: settings.wordWrap ? 'on' : 'off' });
            }
        }

        // 保存设置
        function saveSettings() {
            localStorage.setItem('ideSettings', JSON.stringify(settings));
            closeModal('settingsModal');
            showNotification('success', '成功', '设置已保存');
        }

        // 重置设置
        function resetSettings() {
            if (confirm('确定要重置所有设置吗？')) {
                settings = {
                    fontSize: 14,
                    fontFamily: "'Consolas', 'Monaco', monospace",
                    autoIndent: true,
                    autoSave: false,
                    lineNumbers: true,
                    minimap: true,
                    wordWrap: true,
                    terminalAutoScroll: true,
                    terminalFontSize: 14,
                    terminalMaxLines: 5000,
                    theme: 'vs-dark'
                };
                
                // 更新UI
                document.getElementById('fontSizeSlider').value = settings.fontSize;
                document.getElementById('fontSizeValue').textContent = settings.fontSize + 'px';
                document.getElementById('fontFamily').value = settings.fontFamily;
                document.getElementById('terminalFontSizeSlider').value = settings.terminalFontSize;
                document.getElementById('terminalFontSizeValue').textContent = settings.terminalFontSize + 'px';
                document.getElementById('terminalMaxLines').value = settings.terminalMaxLines;
                document.getElementById('themeSelect').value = settings.theme;
                
                // 更新开关状态
                document.getElementById('autoIndentSwitch').classList.toggle('active', settings.autoIndent);
                document.getElementById('autoSaveSwitch').classList.toggle('active', settings.autoSave);
                document.getElementById('lineNumbersSwitch').classList.toggle('active', settings.lineNumbers);
                document.getElementById('minimapSwitch').classList.toggle('active', settings.minimap);
                document.getElementById('wordWrapSwitch').classList.toggle('active', settings.wordWrap);
                document.getElementById('terminalAutoScrollSwitch').classList.toggle('active', settings.terminalAutoScroll);
                
                // 应用设置
                if (editor) {
                    editor.updateOptions({
                        fontSize: settings.fontSize,
                        fontFamily: settings.fontFamily,
                        lineNumbers: settings.lineNumbers ? 'on' : 'off',
                        minimap: { enabled: settings.minimap },
                        autoIndent: settings.autoIndent ? 'advanced' : 'none',
                        wordWrap: settings.wordWrap ? 'on' : 'off',
                        theme: settings.theme
                    });
                }
                
                showNotification('success', '成功', '设置已重置');
            }
        }

        // 处理终端输入
        function handleTerminalInput(event) {
            if (event.key === 'Enter') {
                const input = event.target.value;
                if (!input.trim()) return;

                // 添加到历史记录
                terminalHistory.push(input);
                terminalHistoryIndex = terminalHistory.length;

                // 显示输入
                addTerminalOutput('>>> ' + input, 'input');

                // 处理特殊命令
                if (input === 'clear' || input === 'clear()') {
                    document.getElementById('terminalOutput').innerHTML = '';
                    event.target.value = '';
                    return;
                }

                if (input === 'help' || input === 'help()') {
                    addTerminalOutput('Web Python IDE Professional 帮助信息', 'output');
                    addTerminalOutput('', 'output');
                    addTerminalOutput('可用命令:', 'output');
                    addTerminalOutput('  help()     - 显示帮助信息', 'output');
                    addTerminalOutput('  clear()    - 清空终端', 'output');
                    addTerminalOutput('  run()      - 运行当前文件', 'output');
                    addTerminalOutput('  files()    - 列出所有文件', 'output');
                    addTerminalOutput('  save(name) - 保存当前文件', 'output');
                    addTerminalOutput('  load(name) - 加载文件', 'output');
                    addTerminalOutput('  time()     - 显示当前时间', 'output');
                    addTerminalOutput('  sys()      - 显示系统信息', 'output');
                    addTerminalOutput('', 'output');
                    addTerminalOutput('快捷键:', 'output');
                    addTerminalOutput('  F5         - 运行代码', 'output');
                    addTerminalOutput('  F6         - 调试代码', 'output');
                    addTerminalOutput('  Ctrl+S     - 保存文件', 'output');
                    addTerminalOutput('  Ctrl+O     - 打开文件', 'output');
                    addTerminalOutput('  Ctrl+F     - 查找替换', 'output');
                    event.target.value = '';
                    return;
                }

                if (input === 'exit') {
                    addTerminalOutput('使用 Ctrl+W 或关闭标签页退出', 'output');
                    event.target.value = '';
                    return;
                }

                if (input === 'files' || input === 'files()') {
                    addTerminalOutput('文件列表:', 'output');
                    for (const fileName in files) {
                        addTerminalOutput('  ' + fileName, 'output');
                    }
                    event.target.value = '';
                    return;
                }

                if (input === 'run' || input === 'run()') {
                    runCode();
                    event.target.value = '';
                    return;
                }

                if (input === 'time' || input === 'time()') {
                    try {
                        const result = pyodide.runPython('time()');
                        addTerminalOutput(result, 'output');
                    } catch (error) {
                        addTerminalOutput('错误: ' + error.message, 'error');
                    }
                    event.target.value = '';
                    return;
                }

                if (input === 'sys' || input === 'sys()') {
                    try {
                        const result = pyodide.runPython('sys()');
                        addTerminalOutput(result, 'output');
                    } catch (error) {
                        addTerminalOutput('错误: ' + error.message, 'error');
                    }
                    event.target.value = '';
                    return;
                }

                // 执行Python代码
                try {
                    pyodide.runPython(`
stdout_capture.clear()
stderr_capture.clear()
                    `);

                    const result = pyodide.runPython(input);
                    const stdout = pyodide.runPython('stdout_capture.getvalue()');
                    const stderr = pyodide.runPython('stderr_capture.getvalue()');

                    if (stdout) {
                        addTerminalOutput(stdout, 'output');
                    }
                    if (stderr) {
                        addTerminalOutput(stderr, 'error');
                    }
                    if (result !== undefined && !stdout && !stderr) {
                        addTerminalOutput(String(result), 'output');
                    }
                } catch (error) {
                    addTerminalOutput('错误: ' + error.message, 'error');
                }

                event.target.value = '';
            } else if (event.key === 'ArrowUp') {
                // 历史记录上一条
                if (terminalHistoryIndex > 0) {
                    terminalHistoryIndex--;
                    event.target.value = terminalHistory[terminalHistoryIndex];
                }
                event.preventDefault();
            } else if (event.key === 'ArrowDown') {
                // 历史记录下一条
                if (terminalHistoryIndex < terminalHistory.length - 1) {
                    terminalHistoryIndex++;
                    event.target.value = terminalHistory[terminalHistoryIndex];
                } else {
                    terminalHistoryIndex = terminalHistory.length;
                    event.target.value = '';
                }
                event.preventDefault();
            } else if (event.key === 'Tab') {
                // Tab键自动补全
                event.preventDefault();
                const input = event.target.value;
                const words = input.split(' ');
                const lastWord = words[words.length - 1];
                
                // 简单的关键词补全
                const keywords = ['print', 'def', 'class', 'if', 'else', 'for', 'while', 'import', 'from', 'try', 'except', 'finally', 'with', 'return', 'yield', 'raise', 'assert', 'del', 'pass', 'break', 'continue', 'global', 'nonlocal', 'lambda', 'and', 'or', 'not', 'in', 'is', 'True', 'False', 'None'];
                
                const matches = keywords.filter(k => k.startsWith(lastWord));
                if (matches.length === 1) {
                    event.target.value = words.slice(0, -1).join(' ') + ' ' + matches[0];
                }
            }
        }

        // 添加终端输出
        function addTerminalOutput(text, type = 'output') {
            const terminalOutput = document.getElementById('terminalOutput');
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.textContent = text;
            terminalOutput.appendChild(line);
            
            // 限制最大行数
            const lines = terminalOutput.children;
            if (lines.length > settings.terminalMaxLines) {
                terminalOutput.removeChild(lines[0]);
            }
            
            // 自动滚动到底部
            if (settings.terminalAutoScroll) {
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }
        }

        // 更新状态
        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        // 显示快速信息
        function showQuickInfo() {
            const fileCount = Object.keys(files).length;
            const versionCount = versions.length;
            const info = `
Web Python IDE Professional v1.0.0

文件: ${fileCount} 个
版本: ${versionCount} 个
语言: Python
编码: UTF-8
主题: ${settings.theme === 'vs-dark' ? '深色' : settings.theme === 'vs' ? '浅色' : '高对比度'}
            `;
            
            showNotification('info', '快速信息', info);
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // 切换全屏模式
        function toggleFullscreen() {
            document.body.classList.toggle('fullscreen');
            
            if (document.body.classList.contains('fullscreen')) {
                showNotification('info', '全屏模式', '按 F11 退出全屏');
            }
        }

        // 显示版本历史
        function showVersionHistory() {
            toggleSidebar('git');
        }

        // 比较版本
        function compareVersions() {
            if (versions.length < 2) {
                showNotification('warning', '提示', '需要至少两个版本才能比较');
                return;
            }
            
            showNotification('info', '提示', '版本比较功能开发中...');
        }

        // 显示命令面板
        function showCommandPalette() {
            const commandPalette = document.getElementById('commandPalette');
            commandPalette.classList.add('active');
            commandPalette.querySelector('input').focus();
            
            // 填充命令列表
            updateCommandList();
        }

        // 更新命令列表
        function updateCommandList() {
            const commandList = document.getElementById('commandList');
            commandList.innerHTML = commands.map(cmd => `
                <div class="command-item" onclick="executeCommand('${cmd.action}')">
                    <i class="${cmd.icon} command-icon"></i>
                    <span class="command-name">${cmd.name}</span>
                    ${cmd.shortcut ? `<span class="command-shortcut">${cmd.shortcut}</span>` : ''}
                </div>
            `).join('');
        }

        // 过滤命令
        function filterCommands(query) {
            const commandList = document.getElementById('commandList');
            const filtered = commands.filter(cmd => 
                cmd.name.toLowerCase().includes(query.toLowerCase())
            );
            
            commandList.innerHTML = filtered.map(cmd => `
                <div class="command-item" onclick="executeCommand('${cmd.action}')">
                    <i class="${cmd.icon} command-icon"></i>
                    <span class="command-name">${cmd.name}</span>
                    ${cmd.shortcut ? `<span class="command-shortcut">${cmd.shortcut}</span>` : ''}
                </div>
            `).join('');
        }

        // 执行命令
        function executeCommand(action) {
            // 关闭命令面板
            document.getElementById('commandPalette').classList.remove('active');
            
            // 执行对应的函数
            switch (action) {
                case 'showNewFileDialog':
                    showNewFileDialog();
                    break;
                case 'showImportDialog':
                    showImportDialog();
                    break;
                case 'saveVersion':
                    saveVersion();
                    break;
                case 'runCode':
                    runCode();
                    break;
                case 'debugCode':
                    debugCode();
                    break;
                case 'toggleSearchReplace':
                    toggleSearchReplace();
                    break;
                case 'formatCode':
                    formatCode();
                    break;
                case 'toggleTerminal':
                    toggleTerminal();
                    break;
                case 'toggleFullscreen':
                    toggleFullscreen();
                    break;
                case 'showSettingsDialog':
                    showSettingsDialog();
                    break;
                case 'showShortcutsDialog':
                    showShortcutsDialog();
                    break;
                case 'showSnippetsDialog':
                    showSnippetsDialog();
                    break;
                case 'exportProject':
                    exportProject();
                    break;
                case 'shareProject':
                    shareProject();
                    break;
                case 'undo':
                    undo();
                    break;
                case 'redo':
                    redo();
                    break;
            }
        }

        // 显示快速打开
        function showQuickOpen() {
            const quickOpen = document.getElementById('quickOpen');
            quickOpen.classList.add('active');
            quickOpen.querySelector('input').focus();
            
            // 填充文件列表
            updateQuickOpenList();
        }

        // 更新快速打开列表
        function updateQuickOpenList() {
            const quickOpenList = document.getElementById('quickOpenList');
            quickOpenList.innerHTML = Object.keys(files).map(fileName => `
                <div class="quick-open-item" onclick="openFile('${fileName}'); document.getElementById('quickOpen').classList.remove('active')">
                    <i class="fab fa-python quick-open-icon"></i>
                    <span class="quick-open-name">${fileName}</span>
                </div>
            `).join('');
        }

        // 过滤快速打开
        function filterQuickOpen(query) {
            const quickOpenList = document.getElementById('quickOpenList');
            const filtered = Object.keys(files).filter(name => 
                name.toLowerCase().includes(query.toLowerCase())
            );
            
            quickOpenList.innerHTML = filtered.map(fileName => `
                <div class="quick-open-item" onclick="openFile('${fileName}'); document.getElementById('quickOpen').classList.remove('active')">
                    <i class="fab fa-python quick-open-icon"></i>
                    <span class="quick-open-name">${fileName}</span>
                </div>
            `).join('');
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // 防止在输入框中触发快捷键
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // Ctrl+P 快速打开
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                showQuickOpen();
            }
            
            // Ctrl+Shift+P 命令面板
            if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                showCommandPalette();
            }
            
            // Ctrl+S 保存
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveVersion();
            }
            
            // Ctrl+O 打开文件
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                showImportDialog();
            }
            
            // Ctrl+N 新建文件
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                showNewFileDialog();
            }
            
            // Ctrl+Shift+S 保存版本
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                saveVersion();
            }
            
            // Ctrl+F 查找替换
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                toggleSearchReplace();
            }
            
            // Ctrl+` 切换终端
            if (e.ctrlKey && e.key === '`') {
                e.preventDefault();
                toggleTerminal();
            }
            
            // F5 运行
            if (e.key === 'F5') {
                e.preventDefault();
                runCode();
            }
            
            // F6 调试
            if (e.key === 'F6') {
                e.preventDefault();
                debugCode();
            }
            
            // Shift+F5 停止
            if (e.shiftKey && e.key === 'F5') {
                e.preventDefault();
                stopExecution();
            }
            
            // F11 全屏
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
            
            // Shift+Alt+F 格式化
            if (e.shiftKey && e.altKey && e.key === 'F') {
                e.preventDefault();
                formatCode();
            }
            
            // Ctrl+Enter 运行选中代码
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                runSelection();
            }
            
            // Ctrl+Z 撤销
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            
            // Ctrl+Y 重做
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
            
            // ESC 关闭模态框和面板
            if (e.key === 'Escape') {
                // 关闭所有模态框
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
                
                // 关闭命令面板
                document.getElementById('commandPalette').classList.remove('active');
                
                // 关闭快速打开
                document.getElementById('quickOpen').classList.remove('active');
                
                // 关闭搜索替换
                document.getElementById('searchReplaceBar').classList.remove('active');
            }
        });

        // 拖放功能
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.add('active');
        });

        document.addEventListener('dragleave', function(e) {
            if (e.target === document.getElementById('dropZone')) {
                document.getElementById('dropZone').classList.remove('active');
            }
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.remove('active');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                let importedCount = 0;
                
                Array.from(files).forEach(file => {
                    if (file.name.endsWith('.py')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const fileName = file.name;
                            window.files[fileName] = {
                                name: fileName,
                                content: event.target.result,
                                modified: false,
                                created: new Date(),
                                size: file.size
                            };
                            importedCount++;
                            
                            if (importedCount === Array.from(files).filter(f => f.name.endsWith('.py')).length) {
                                updateFileTree();
                                showNotification('success', '成功', `已导入 ${importedCount} 个文件`);
                            }
                        };
                        reader.readAsText(file);
                    }
                });
            }
        });

        // 检查分享链接
        window.addEventListener('load', function() {
            const hash = window.location.hash;
            if (hash.startsWith('#share=')) {
                try {
                    const data = JSON.parse(atob(hash.substring(7)));
                    if (data.files) {
                        files = data.files;
                        versions = data.versions || [];
                        if (data.settings) {
                            settings = {...settings, ...data.settings};
                        }
                        createDefaultFile();
                        updateFileTree();
                        updateVersionCount();
                        showNotification('success', '成功', '项目已从分享链接加载');
                    }
                } catch (e) {
                    console.error('Failed to load shared project:', e);
                }
            } else if (hash.startsWith('#file=')) {
                try {
                    const data = JSON.parse(atob(hash.substring(6)));
                    if (data.name && data.content) {
                        files[data.name] = {
                            name: data.name,
                            content: data.content,
                            modified: false,
                            created: new Date(),
                            size: new Blob([data.content]).size
                        };
                        openFile(data.name);
                        updateFileTree();
                        showNotification('success', '成功', '文件已从分享链接加载');
                    }
                } catch (e) {
                    console.error('Failed to load shared file:', e);
                }
            }
        });

        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('ideSettings');
            if (savedSettings) {
                settings = {...settings, ...JSON.parse(savedSettings)};
            }
        }

        // 添加通知动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes notificationSlideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // 初始化应用
        window.onload = function() {
            loadSettings();
            initializeApp();
        };

        // 监听窗口大小变化
        window.addEventListener('resize', function() {
            if (editor) {
                editor.layout();
            }
        });

        // 定期保存设置
        setInterval(() => {
            localStorage.setItem('ideSettings', JSON.stringify(settings));
        }, 30000); // 每30秒保存一次

        // 添加页面离开提示
        window.addEventListener('beforeunload', function(e) {
            let hasUnsavedChanges = false;
            for (const fileName in files) {
                if (files[fileName].modified) {
                    hasUnsavedChanges = true;
                    break;
                }
            }
            
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>